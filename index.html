<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üÉè Americano Oyun Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .hidden { display: none !important; }
        .fade-in { 
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        /* Language Toggle Styles */
        .language-toggle {
            position: relative;
            display: inline-flex;
            align-items: center;
            background: #f3f4f6;
            border-radius: 12px;
            padding: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .language-toggle.dark {
            background: #374151;
        }
        
        .language-option {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            z-index: 2;
        }
        
        .language-option.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .language-option.inactive {
            color: #6b7280;
        }
        
        .language-option.inactive.dark {
            color: #9ca3af;
        }
        
        /* Mobil i√ßin √∂zel input styling */
        @media (max-width: 768px) {
            /* T√ºm grid'leri mobilde tek kolona zorla */
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            input[type="text"], input[type="number"], select {
                font-size: 18px !important;
                padding: 16px !important;
                min-height: 60px !important;
                line-height: 1.2 !important;
                width: 100% !important;
            }
            
            input::placeholder {
                font-size: 16px !important;
            }
            
            /* Mobil Safari i√ßin zoom engelleyici */
            input[type="text"]:focus,
            input[type="number"]:focus,
            select:focus {
                font-size: 18px !important;
                transform: scale(1);
            }
            
            /* Button'larƒ± da b√ºy√ºlt */
            button {
                min-height: 48px !important;
                font-size: 14px !important;
                padding: 12px 16px !important;
            }
            
            /* Player cards'ƒ±nƒ± daha geni≈ü yap */
            .grid > div {
                width: 100% !important;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-7xl mx-auto p-6 min-h-screen transition-colors bg-gradient-to-br from-purple-50 to-blue-100">
        
        <!-- Setup Screen -->
        <div id="setupScreen" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <div class="w-8 h-8 text-purple-600 flex items-center justify-center">‚öôÔ∏è</div>
                        <h1 id="setupTitle" class="text-3xl font-bold text-gray-800">üÉè Americano Oyun Kurulumu</h1>
                        <!-- Language Toggle -->
                        <div class="ml-4">
                            <div id="languageToggle" class="language-toggle" onclick="toggleLanguage()">
                                <div id="langTr" class="language-option active">TR</div>
                                <div id="langEn" class="language-option inactive">EN</div>
                                <!-- Penalty Management Modal -->
        <div id="penaltyManagementModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="max-w-6xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
                <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <div>
                            <h2 id="penaltyManagementModalTitle" class="text-2xl font-bold text-gray-800">üéØ Cezalarƒ± Y√∂net</h2>
                            <p class="text-gray-600 mt-1">
                                <span id="selectedCountDisplay" class="font-bold text-purple-600">13</span> / 13 
                                <span id="penaltyCountLabel">ceza se√ßili</span>
                            </p>
                        </div>
                        <button onclick="closePenaltyManagement()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Warning Message -->
                    <div id="penaltyWarning" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
                        <p class="text-red-800 font-medium" id="penaltyWarningText">
                            Tam olarak 13 ceza se√ßmelisiniz
                        </p>
                    </div>

                    <!-- Default Penalties Section -->
                    <div class="mb-8">
                        <h3 id="defaultPenaltiesTitle" class="text-xl font-bold text-gray-800 mb-4">üìã Varsayƒ±lan Cezalar</h3>
                        <div id="defaultPenaltiesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Default penalties will be populated here -->
                        </div>
                    </div>

                    <!-- Difficult Penalties Section -->
                    <div class="mb-8">
                        <h3 id="difficultPenaltiesTitle" class="text-xl font-bold text-gray-800 mb-4">üß† Zor Cezalar</h3>
                        <p id="difficultPenaltiesDesc" class="text-gray-600 mb-4">Daha zorlu oyun deneyimi i√ßin √∂zel cezalar</p>
                        <div id="difficultPenaltiesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Difficult penalties will be populated here -->
                        </div>
                    </div>

                    <!-- Custom Penalties Section -->
                    <div class="mb-8">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="customPenaltiesTitle" class="text-xl font-bold text-gray-800">‚ö° √ñzel Cezalar</h3>
                            <button onclick="openAddPenaltyModal()" id="addNewPenaltyBtn" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-all">
                                ‚ûï <span id="addNewPenaltyText">Yeni Ceza Ekle</span>
                            </button>
                        </div>
                        <div id="customPenaltiesList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            <!-- Custom penalties will be populated here -->
                        </div>
                        <div id="noCustomPenalties" class="text-center py-8 text-gray-500">
                            <p id="noCustomPenaltiesText">Hen√ºz √∂zel ceza eklenmemi≈ü</p>
                            <p class="text-sm mt-1" id="addCustomPenaltyHint">Yukarƒ±daki butona tƒ±klayarak yeni ceza ekleyebilirsiniz</p>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-4 justify-center pt-6 border-t border-gray-200">
                        <button onclick="resetToDefaultPenalties()" id="resetDefaultsBtn" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white font-bold rounded-lg transition-all">
                            üîÑ <span id="resetDefaultsText">Varsayƒ±lanlara Sƒ±fƒ±rla</span>
                        </button>
                        <button onclick="applyPenaltySelection()" id="applyPenaltiesBtn" class="px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-all">
                            ‚úÖ <span id="applyPenaltiesText">Cezalarƒ± Uygula</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add New Penalty Modal -->
        <div id="addPenaltyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" style="z-index: 60;">
            <div class="max-w-md w-full rounded-2xl shadow-2xl bg-white">
                <div class="p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 id="addPenaltyModalTitle" class="text-2xl font-bold text-gray-800">‚ûï Yeni Ceza Ekle</h2>
                        <button onclick="closeAddPenaltyModal()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="addPenaltyForm" onsubmit="saveNewPenalty(event)">
                        <div class="space-y-4">
                            <div>
                                <label id="penaltyNameLabel" class="block text-sm font-medium text-gray-700 mb-2">Ceza Adƒ±:</label>
                                <input type="text" id="newPenaltyName" required 
                                       class="w-full p-3 border border-gray-300 rounded-lg font-medium"
                                       placeholder="√ñrnek: 6'lƒ± Seri" />
                            </div>
                            
                            <div>
                                <label id="penaltyShortLabel" class="block text-sm font-medium text-gray-700 mb-2">Kƒ±sa Ad:</label>
                                <input type="text" id="newPenaltyShort" required maxlength="10"
                                       class="w-full p-3 border border-gray-300 rounded-lg font-medium"
                                       placeholder="√ñrnek: 6S" />
                            </div>
                            
                            <div>
                                <label id="penaltySymbolLabel" class="block text-sm font-medium text-gray-700 mb-2">Sembol:</label>
                                <input type="text" id="newPenaltySymbol" readonly
                                       class="w-full p-3 border border-gray-300 rounded-lg font-medium bg-gray-100"
                                       placeholder="Otomatik olu≈üturulacak" />
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p id="addPenaltyNote" class="text-sm text-blue-700">
                                    <strong>Not:</strong> Eklediƒüiniz √∂zel ceza, normal cezalar gibi oyunda kullanƒ±labilecek.
                                    Sembol otomatik olarak olu≈üturulacak.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="closeAddPenaltyModal()" id="cancelAddPenalty"
                                    class="flex-1 py-3 px-4 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-all">
                                ƒ∞ptal
                            </button>
                            <button type="submit" id="submitAddPenalty"
                                    class="flex-1 py-3 px-4 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-all">
                                Ceza Ekle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
                        </div>
                    </div>
                    <p id="setupSubtitle" class="text-gray-600">Oyuncu sayƒ±sƒ± ve isimlerini ayarlayƒ±n</p>
                </div>

                <!-- Player Count Section -->
                <div class="rounded-xl p-6 mb-6 bg-blue-50">
                    <h3 id="playerCountTitle" class="font-bold text-lg mb-4 text-center text-gray-800">Oyuncu Sayƒ±sƒ±</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button id="removePlayerBtn" class="p-3 rounded-lg font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed">
                            ‚ûñ
                        </button>
                        <div id="playerCountDisplay" class="text-4xl font-bold text-purple-600 rounded-lg py-3 px-6 shadow-inner min-w-[80px] text-center bg-white">
                            3
                        </div>
                        <button id="addPlayerBtn" class="p-3 rounded-lg font-bold transition-all bg-green-500 text-white hover:bg-green-600">
                            ‚ûï
                        </button>
                    </div>
                    <p id="playerCountDesc" class="text-center mt-2 text-gray-600">3-5 oyuncu</p>
                </div>

                <!-- Player Names Section -->
                <div class="rounded-xl p-6 mb-6 bg-yellow-50">
                    <h3 id="playerNamesTitle" class="font-bold text-lg mb-4 text-center text-gray-800">Oyuncu ƒ∞simleri</h3>
                    <div id="playerInputs" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                        <!-- Player inputs will be dynamically generated -->
                    </div>
                </div>

                <!-- Penalty Management Section -->
                <div class="rounded-xl p-6 mb-6 bg-purple-50">
                    <h3 id="penaltyManagementTitle" class="font-bold text-lg mb-4 text-center text-gray-800">üéØ Cezalarƒ± Y√∂net</h3>
                    <div class="text-center">
                        <p id="penaltyManagementDesc" class="text-gray-600 mb-4">Oyunda kullanƒ±lacak cezalarƒ± √∂zelle≈ütirin</p>
                        <div class="mb-4">
                            <span id="activePenaltyCount" class="bg-purple-100 text-purple-800 px-3 py-2 rounded-full font-bold">13</span>
                            <span class="text-gray-600 ml-2" id="activePenaltyLabel">ceza se√ßili</span>
                        </div>
                        <button id="managePenaltiesBtn" onclick="openPenaltyManagement()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-all">
                            ‚öôÔ∏è <span id="managePenaltiesBtnText">Cezalarƒ± Y√∂net</span>
                        </button>
                    </div>
                </div>

                <!-- Game Stake Section -->
                <div class="rounded-xl p-6 mb-6 bg-orange-50">
                    <h3 id="gameStakeTitle" class="font-bold text-lg mb-4 text-center text-gray-800">Bu Oyun Neye Oynanƒ±yor?</h3>
                    <div class="mb-4">
                        <input type="text" id="gameStakeInput" class="w-full p-4 md:p-4 text-lg md:text-xl min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg text-center font-medium"
                               placeholder="√ñrnek: Kahve ƒ±smarlama, Yemek ƒ±smarlama..." style="font-size: 18px !important; padding: 16px !important;" />
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <button onclick="setStake('coffee')" id="coffeeBtn" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">‚òï Kahve</button>
                        <button onclick="setStake('food')" id="foodBtn" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">üçï Yemek</button>
                        <button onclick="setStake('icecream')" id="icecreamBtn" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">üç¶ Dondurma</button>
                        <button onclick="setStake('fun')" id="funBtn" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">üéâ Eƒülence</button>
                        <button onclick="setStake('money')" id="moneyBtn" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">üí∞ Para</button>
                        <button onclick="setCustomStake()" id="customBtn" class="p-2 rounded-lg text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 transition-colors">‚úèÔ∏è √ñzel</button>
                    </div>
                </div>

                <!-- Start Button -->
                <div class="text-center">
                    <button id="startGameBtn" class="px-8 py-4 rounded-lg font-bold text-white text-xl transition-all bg-gray-400 cursor-not-allowed">
                        üéØ Oyunu Ba≈ülat
                    </button>
                    <div id="startGameError" class="text-red-500 mt-2 text-sm hidden">L√ºtfen t√ºm oyuncu isimlerini doldurun</div>
                    <div id="gameStakeDisplay" class="mt-3 p-2 bg-orange-100 rounded-lg hidden">
                        <p class="text-orange-800 text-sm">üèÜ <span id="thisGameLabel">Bu oyun</span>: <strong id="gameStakeText"></strong></p>
                    </div>
                </div>

                <!-- Rules Section -->
                <div class="bg-green-50 rounded-xl p-6 mt-6">
                    <h3 id="gameRulesTitle" class="font-bold text-lg text-gray-800 mb-3">Oyun Kurallarƒ±:</h3>
                    <ul id="gameRulesList" class="space-y-2 text-gray-700">
                        <li>‚Ä¢ <strong>3, 4 veya 5 oyuncuyla</strong> oynanƒ±r</li>
                        <li>‚Ä¢ <strong>13 farklƒ± ceza</strong> t√ºr√º vardƒ±r</li>
                        <li>‚Ä¢ <strong>"Elden" cezasƒ±</strong> mecburen son elde (13. el) oynanƒ±r</li>
                        <li>‚Ä¢ <strong>Cezayƒ± s√∂yleyen VE bitiren</strong> aynƒ± ki≈üiyse +50 puan</li>
                        <li>‚Ä¢ <strong>Cezayƒ± s√∂yleyen ba≈üarƒ±sƒ±z:</strong> G√∂revini yapamadan (a√ßamadan) ba≈ükasƒ± bitirirse x2 ceza puanƒ± alƒ±r</li>
                        <li>‚Ä¢ <strong>Son elde (Elden) bonus yok:</strong> Cezayƒ± s√∂yleyip bitiren +50 alamaz</li>
                        <li>‚Ä¢ <strong>ƒ∞≈üler kaƒüƒ±t atan</strong> oyuncu -50 ceza puanƒ± alƒ±r</li>
                        <li>‚Ä¢ <strong>Joker ile bitiren</strong> herkese x2 ceza puanƒ± yedirir</li>
                        <li>‚Ä¢ <strong>Kazanma:</strong> En y√ºksek puan kazanƒ±r (eksi puanlarda en d√º≈ü√ºk eksi puan)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden rounded-2xl shadow-xl p-8 bg-white">
            
            <!-- Game Header -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div class="w-8 h-8 text-purple-600 flex items-center justify-center">‚ñ∂Ô∏è</div>
                    <h1 class="text-3xl font-bold text-gray-800">üÉè Americano</h1>
                    <button onclick="backToSetup()" class="ml-4 p-2 transition-all rounded-lg text-gray-500 hover:text-gray-700" title="Ayarlara d√∂n">
                        ‚öôÔ∏è
                    </button>
                    <button id="darkModeBtn" onclick="toggleDarkMode()" class="ml-2 p-2 rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" title="Gece modu">
                        üåô
                    </button>
                    <!-- Language Toggle in Game -->
                    <div class="ml-2">
                        <div id="languageToggleGame" class="language-toggle" onclick="event.stopPropagation(); toggleLanguage()">
                            <div id="langTrGame" class="language-option active">TR</div>
                            <div id="langEnGame" class="language-option inactive">EN</div>
                        </div>
                    </div>
                </div>
                <p id="playersDisplay" class="text-gray-600"></p>
                <div class="mt-2 text-lg font-semibold text-purple-600">
                    <span id="roundLabel">El</span> <span id="currentRoundDisplay">1</span> - <span id="remainingPenaltiesDisplay">13</span>/13 <span id="penaltiesLeftLabel">ceza kaldƒ±</span>
                </div>
                <div id="gameStakeGameDisplay" class="mt-2 text-sm text-orange-600 hidden">
                    üèÜ <span id="thisGameLabelGame">Bu oyun</span>: <strong id="gameStakeGameText"></strong>
                </div>
            </div>

            <!-- Leader Banner -->
            <div id="leaderBanner" class="p-4 rounded-xl mb-6 text-center bg-gradient-to-r from-purple-400 to-blue-500 text-white hidden">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 flex items-center justify-center">üèÜ</div>
                    <span id="leaderText" class="font-bold text-lg"></span>
                </div>
            </div>

            <!-- Score Cards -->
            <div id="scoreCards" class="grid gap-4 mb-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                <!-- Score cards will be dynamically generated -->
            </div>

            <!-- Round Input Section -->
            <div id="roundInputSection" class="bg-blue-50 rounded-xl p-6 mb-6">
                <h3 class="font-bold text-lg text-gray-800 mb-4"><span id="roundInputLabel">El</span> <span id="roundInputTitle">1</span> - <span id="scoreInputLabel">Puan Giri≈üi</span></h3>
                
                <!-- Penalty and Caller Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label id="penaltyPlayedLabel" class="block text-sm font-medium text-gray-700 mb-2">Bu Elde Oynanan Ceza:</label>
                        <select id="selectedPenalty" class="w-full p-4 md:p-3 text-lg md:text-lg min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg font-medium" style="font-size: 18px !important; padding: 16px !important;">
                            <option value="" id="selectPenaltyOption">Ceza se√ßin...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label id="penaltyCallerLabel" class="block text-sm font-medium text-gray-700 mb-2">Cezayƒ± S√∂yleyen Oyuncu:</label>
                        <select id="penaltyCaller" class="w-full p-4 md:p-3 text-lg md:text-lg min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg font-medium" style="font-size: 18px !important; padding: 16px !important;">
                            <option value="" id="selectPlayerOption">Oyuncu se√ßin...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Player Input Cards -->
                <div id="playerInputCards" class="grid gap-4 mb-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                    <!-- Player input cards will be dynamically generated -->
                </div>
                
                <!-- Calculate Button -->
                <div class="text-center">
                    <div id="warningMessages">
                        <!-- Warning messages will be dynamically added here -->
                    </div>
                    
                    <button id="calculateBtn" onclick="calculateRoundScore()" class="px-8 py-3 rounded-lg font-bold text-white transition-all bg-gray-400 cursor-not-allowed">
                        <span id="calculateBtnText">T√ºm Alanlarƒ± Doldurun</span>
                    </button>
                </div>
            </div>

            <!-- Game Over -->
            <div id="gameOverSection" class="bg-gradient-to-r from-green-400 to-blue-500 text-white p-6 rounded-xl mb-6 text-center hidden">
                <h2 id="gameOverTitle" class="text-2xl font-bold mb-2">üéâ OYUN Bƒ∞TTƒ∞! üéâ</h2>
                <p id="gameOverText" class="text-lg"></p>
            </div>

            <!-- Game History Table -->
            <div id="gameHistorySection" class="bg-gray-50 rounded-xl p-6 mb-6 hidden">
                <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                    <div class="w-5 h-5 flex items-center justify-center">üìä</div>
                    <span id="scoreTableTitle">K√ºm√ºlatif Puan Tablosu</span>
                </h3>
                <div class="overflow-x-auto">
                    <table id="gameHistoryTable" class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow">
                        <thead id="gameHistoryTableHead">
                            <!-- Table header will be dynamically generated -->
                        </thead>
                        <tbody id="gameHistoryTableBody">
                            <!-- Table body will be dynamically generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Remaining Penalties -->
            <div class="bg-yellow-50 rounded-xl p-6 mb-6">
                <h3 class="font-bold text-lg text-gray-800 mb-4 text-center">
                    <span id="remainingPenaltiesTitle">Kalan Cezalar</span> - <span id="remainingCount">13</span>/13
                </h3>
                <div id="remainingPenalties" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Remaining penalties will be dynamically generated -->
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex gap-4 justify-center flex-wrap">
                <button onclick="showGameHistory()" id="historyBtn" class="font-bold py-3 px-6 rounded-lg transition-all bg-green-500 hover:bg-green-600 text-white">
                    üìä <span id="historyBtnText">Ge√ßmi≈ü Oyunlar</span>
                </button>
                <button onclick="showRules()" id="rulesBtn" class="font-bold py-3 px-6 rounded-lg transition-all bg-blue-500 hover:bg-blue-600 text-white">
                    üìñ <span id="rulesBtnText">Kurallarƒ± Oku</span>
                </button>
                <button onclick="backToSetup()" id="settingsBtn" class="font-bold py-3 px-6 rounded-lg transition-all hover:scale-105 flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white">
                    <div class="w-5 h-5 flex items-center justify-center">‚öôÔ∏è</div>
                    <span id="settingsBtnText">Oyuncu Ayarlarƒ±</span>
                </button>
                <button onclick="resetGame()" id="newGameBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-all hover:scale-105 flex items-center gap-2">
                    <div class="w-5 h-5 flex items-center justify-center">üîÑ</div>
                    <span id="newGameBtnText">Yeni Oyun Ba≈ülat</span>
                </button>
            </div>
        </div>

        <!-- Game History Modal -->
        <div id="gameHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="max-w-4xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
                <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 id="gameHistoryModalTitle" class="text-2xl font-bold text-gray-800">üìä Ge√ßmi≈ü Oyunlar</h2>
                        <button onclick="closeGameHistoryModal()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="gameHistoryList">
                        <!-- Game history will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Detail Modal -->
        <div id="gameDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="max-w-4xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
                <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 id="gameDetailModalTitle" class="text-2xl font-bold text-gray-800">üéÆ Oyun Detaylarƒ±</h2>
                        <button onclick="closeGameDetailModal()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            ‚úï
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="gameDetailContent">
                        <!-- Game detail will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Translations object
        const translations = {
            tr: {
                // Setup Screen
                gameSetupTitle: 'üÉè Americano Oyun Kurulumu',
                gameSetupSubtitle: 'Oyuncu sayƒ±sƒ± ve isimlerini ayarlayƒ±n',
                playerCount: 'Oyuncu Sayƒ±sƒ±',
                playerCountDesc: '3-5 oyuncu',
                playerNames: 'Oyuncu ƒ∞simleri',
                gameStakeTitle: 'Bu Oyun Neye Oynanƒ±yor?',
                gameStakePlaceholder: '√ñrnek: Kahve ƒ±smarlama, Yemek ƒ±smarlama...',
                startGame: 'üéØ Oyunu Ba≈ülat',
                fillAllFields: 'L√ºtfen t√ºm oyuncu isimlerini doldurun',
                thisGame: 'Bu oyun',
                gameRules: 'Oyun Kurallarƒ±:',
                
                // Game Screen
                round: 'El',
                penaltiesLeft: 'ceza kaldƒ±',
                leader: 'Lider',
                totalScore: 'toplam puan',
                scoreInput: 'Puan Giri≈üi',
                penaltyPlayed: 'Bu Elde Oynanan Ceza:',
                selectPenalty: 'Ceza se√ßin...',
                penaltyCaller: 'Cezayƒ± S√∂yleyen Oyuncu:',
                selectPlayer: 'Oyuncu se√ßin...',
                thisRoundPenalty: 'Bu Elde Ceza Sayƒ±sƒ±',
                finishedRound: 'Eli Bitirdi',
                finishedWithJoker: 'Joker ƒ∞le Bitirdi',
                threwUselessCard: 'ƒ∞≈üler Kaƒüƒ±t Attƒ±',
                failedToComplete: 'G√∂revini A√ßamadƒ±',
                onlyForCaller: 'Sadece Ceza S√∂yleyen ƒ∞√ßin',
                calculateRound: 'Eli Kaydet ve Sonrakine Ge√ß',
                fillAllRequiredFields: 'T√ºm Alanlarƒ± Doldurun',
                
                // Game Over
                gameOver: 'OYUN Bƒ∞TTƒ∞!',
                allPenaltiesPlayed: 'T√ºm cezalar oynandƒ±. Kazanan:',
                
                // Buttons
                gameHistory: 'Ge√ßmi≈ü Oyunlar',
                readRules: 'Kurallarƒ± Oku',
                playerSettings: 'Oyuncu Ayarlarƒ±',
                newGame: 'Yeni Oyun Ba≈ülat',
                
                // Stakes
                coffee: 'Kahve ƒ±smarlama',
                food: 'Yemek ƒ±smarlama',
                icecream: 'Dondurma ƒ±smarlama',
                fun: 'Sadece eƒülence',
                money: 'Para',
                custom: '√ñzel',
                
                // Penalties (Turkish names)
                penalties: {
                    "3S": "3'l√º Seri",
                    "3K": "3'l√º K√ºt", 
                    "3S3K": "3'l√º Seri + 3'l√º K√ºt",
                    "23S": "2 3'l√º Seri",
                    "23K": "2 3'l√º K√ºt",
                    "4S": "4'l√º Seri",
                    "4K": "4'l√º K√ºt",
                    "4S4K": "4 Seri 4 K√ºt",
                    "24S": "2 4'l√º Seri",
                    "24K": "2 4'l√º K√ºt",
                    "5S": "5'li Seri",
                    "√á": "√áift",
                    "E": "Elden",
                    // Difficult penalties
                    "5√á": "5 √áift",
                    "6√á": "6 √áift",
                    "7√á": "7 √áift",
                    "34K": "3 x 4'l√º K√ºt",
                    "34S": "3 x 4'l√º Seri",
                    "7S": "7'li Seri",
                    "8S": "8'li Seri",
                    "43K": "4 x 3'l√º K√ºt",
                    "43S": "4 x 3'l√º Seri",
                    "33S1K": "3 x 3'l√º Seri + 1 K√ºt",
                    "33K1S": "3 x 3'l√º K√ºt + 1 Seri"
                },
                
                // Modal titles
                gameHistoryModalTitle: 'üìä Ge√ßmi≈ü Oyunlar',
                gameDetailModalTitle: 'üéÆ Oyun Detaylarƒ±',
                
                // Table headers
                round: 'El',
                penalty: 'Ceza',
                caller: 'S√∂yleyen',
                winner: 'Bitiren',
                
                // Messages
                noGameHistory: 'Hen√ºz oyun ge√ßmi≈üi yok',
                completeFirstGame: 'ƒ∞lk oyununuzu tamamlayƒ±n ve burada g√∂r√ºn',
                remainingPenalties: 'Kalan Cezalar',
                scoreTable: 'K√ºm√ºlatif Puan Tablosu',
                
                // Status messages
                bonusPoints: '+50 bonus puan (S√∂yledi ve Bitirdi)',
                noLastRoundBonus: 'Son elde bonus yok (Elden kuralƒ±)',
                jokerEffect: 'üÉè Joker etkisi: Herkese x2 ceza puanƒ±',
                uselessCardPenalty: '-50 ceza puanƒ± (ƒ∞≈üler kaƒüƒ±t)',
                failedCallerPenalty: 'x2 ceza puanƒ± (G√∂revini a√ßamadƒ±)',
                
                // Player labels
                player: 'Oyuncu',
                points: 'puan',
                
                // Warning messages
                callerFailedWarning: 'Cezayƒ± S√∂yleyen G√∂revini A√ßamadƒ±!',
                callerFailedDesc: 'cezayƒ± s√∂yledi ama g√∂revini a√ßamadƒ± - x2 ceza puanƒ± alacak',
                lastRoundRule: 'Son El (Elden) Kuralƒ±',
                lastRoundRuleDesc: 'Bu elde cezayƒ± s√∂yleyip bitiren oyuncu +50 bonus alamaz',
                jokerEffectActive: 'Joker Etkisi Aktif!',
                jokerEffectDesc: 'joker ile bitirdi - T√ºm ceza puanlarƒ± x2 olacak',
                missingFields: 'Eksik alanlar:',
                selectPlayedPenalty: '‚Ä¢ Oynanan cezayƒ± se√ßin',
                selectPenaltyCaller: '‚Ä¢ Cezayƒ± s√∂yleyen oyuncuyu se√ßin',
                selectRoundWinner: '‚Ä¢ Eli bitiren oyuncuyu se√ßin',
                enterOtherPenalties: '‚Ä¢ Diƒüer oyuncularƒ±n ceza sayƒ±sƒ±nƒ± girin',
                
                // Penalty Management
                managePenalties: 'Cezalarƒ± Y√∂net',
                penaltiesSelected: 'Ceza Se√ßili',
                selectPenaltiesToPlay: 'Oyunda kullanƒ±lacak cezalarƒ± se√ßin',
                defaultPenalties: 'Varsayƒ±lan Cezalar',
                difficultPenalties: 'Zor Cezalar',
                customPenalties: '√ñzel Cezalar',
                addNewPenalty: 'Yeni Ceza Ekle',
                exactly13Required: 'Tam olarak 13 ceza se√ßmelisiniz',
                penaltyCount: 'ceza',
                goingOutMandatory: '(Zorunlu)',
                penaltyName: 'Ceza Adƒ±',
                penaltyShort: 'Kƒ±sa Ad',
                penaltySymbol: 'Sembol',
                autoGenerated: 'Otomatik olu≈üturulacak',
                addPenalty: 'Ceza Ekle',
                cancel: 'ƒ∞ptal',
                penaltyNote: 'Eklediƒüiniz √∂zel ceza, normal cezalar gibi oyunda kullanƒ±labilecek.',
                resetToDefaults: 'Varsayƒ±lanlara Sƒ±fƒ±rla',
                applyPenalties: 'Cezalarƒ± Uygula'
            },
            en: {
                // Setup Screen
                gameSetupTitle: 'üÉè Americano Game Setup',
                gameSetupSubtitle: 'Set player count and names',
                playerCount: 'Player Count',
                playerCountDesc: '3-5 players',
                playerNames: 'Player Names',
                gameStakeTitle: 'What is this game for?',
                gameStakePlaceholder: 'Example: Coffee treat, Dinner treat...',
                startGame: 'üéØ Start Game',
                fillAllFields: 'Please fill in all player names',
                thisGame: 'This game',
                gameRules: 'Game Rules:',
                
                // Game Screen
                round: 'Round',
                penaltiesLeft: 'penalties left',
                leader: 'Leader',
                totalScore: 'total score',
                scoreInput: 'Score Input',
                penaltyPlayed: 'Penalty Played This Round:',
                selectPenalty: 'Select penalty...',
                penaltyCaller: 'Player Who Called Penalty:',
                selectPlayer: 'Select player...',
                thisRoundPenalty: 'Penalty Count This Round',
                finishedRound: 'Finished Round',
                finishedWithJoker: 'Finished With Joker',
                threwUselessCard: 'Threw Useless Card',
                failedToComplete: 'Failed to Complete',
                onlyForCaller: 'Only for Penalty Caller',
                calculateRound: 'Save Round and Continue',
                fillAllRequiredFields: 'Fill All Required Fields',
                
                // Game Over
                gameOver: 'GAME OVER!',
                allPenaltiesPlayed: 'All penalties played. Winner:',
                
                // Buttons
                gameHistory: 'Game History',
                readRules: 'Read Rules',
                playerSettings: 'Player Settings',
                newGame: 'Start New Game',
                
                // Stakes
                coffee: 'Coffee treat',
                food: 'Food treat',
                icecream: 'Ice cream treat',
                fun: 'Just for fun',
                money: 'Money',
                custom: 'Custom',
                
                // Penalties (English names)
                penalties: {
                    "3S": "3-Card Sequence",
                    "3K": "3-Card Set",
                    "3S3K": "3-Card Sequence + 3-Card Set",
                    "23S": "2 3-Card Sequences",
                    "23K": "2 3-Card Sets",
                    "4S": "4-Card Sequence",
                    "4K": "4-Card Set",
                    "4S4K": "4-Card Sequence + 4-Card Set",
                    "24S": "2 4-Card Sequences",
                    "24K": "2 4-Card Sets",
                    "5S": "5-Card Sequence",
                    "√á": "Pair",
                    "E": "Going Out",
                    // Difficult penalties
                    "5√á": "5 Pairs",
                    "6√á": "6 Pairs",
                    "7√á": "7 Pairs",
                    "34K": "3 x 4-Card Sets",
                    "34S": "3 x 4-Card Sequences",
                    "7S": "7-Card Sequence",
                    "8S": "8-Card Sequence",
                    "43K": "4 x 3-Card Sets",
                    "43S": "4 x 3-Card Sequences",
                    "33S1K": "3 x 3-Card Sequences + 1 Set",
                    "33K1S": "3 x 3-Card Sets + 1 Sequence"
                },
                
                // Modal titles
                gameHistoryModalTitle: 'üìä Game History',
                gameDetailModalTitle: 'üéÆ Game Details',
                
                // Table headers
                round: 'Round',
                penalty: 'Penalty',
                caller: 'Caller',
                winner: 'Winner',
                
                // Messages
                noGameHistory: 'No game history yet',
                completeFirstGame: 'Complete your first game to see it here',
                remainingPenalties: 'Remaining Penalties',
                scoreTable: 'Cumulative Score Table',
                
                // Status messages
                bonusPoints: '+50 bonus points (Called and Finished)',
                noLastRoundBonus: 'No bonus in last round (Going Out rule)',
                jokerEffect: 'üÉè Joker effect: x2 penalty points for everyone',
                uselessCardPenalty: '-50 penalty points (Useless card)',
                failedCallerPenalty: 'x2 penalty points (Failed to complete)',
                
                // Player labels
                player: 'Player',
                points: 'points',
                
                // Warning messages
                callerFailedWarning: 'Penalty Caller Failed to Complete!',
                callerFailedDesc: 'called the penalty but failed to complete - will get x2 penalty points',
                lastRoundRule: 'Last Round (Going Out) Rule',
                lastRoundRuleDesc: 'Player who calls and finishes this round cannot get +50 bonus',
                jokerEffectActive: 'Joker Effect Active!',
                jokerEffectDesc: 'finished with joker - All penalty points will be x2',
                missingFields: 'Missing fields:',
                selectPlayedPenalty: '‚Ä¢ Select the played penalty',
                selectPenaltyCaller: '‚Ä¢ Select the penalty caller',
                selectRoundWinner: '‚Ä¢ Select the round winner',
                enterOtherPenalties: '‚Ä¢ Enter other players\' penalty counts',
                
                // Penalty Management
                managePenalties: 'Manage Penalties',
                penaltiesSelected: 'Penalties Selected',
                selectPenaltiesToPlay: 'Select penalties to use in game',
                defaultPenalties: 'Default Penalties',
                difficultPenalties: 'Difficult Penalties',
                customPenalties: 'Custom Penalties',
                addNewPenalty: 'Add New Penalty',
                exactly13Required: 'You must select exactly 13 penalties',
                penaltyCount: 'penalties',
                goingOutMandatory: '(Mandatory)',
                penaltyName: 'Penalty Name',
                penaltyShort: 'Short Name',
                penaltySymbol: 'Symbol',
                autoGenerated: 'Will be auto-generated',
                addPenalty: 'Add Penalty',
                cancel: 'Cancel',
                penaltyNote: 'Your custom penalty will be available like normal penalties in the game.',
                resetToDefaults: 'Reset to Defaults',
                applyPenalties: 'Apply Penalties'
            }
        };

        // Game state variables
        let gameState = {
            language: 'tr', // Default language
            gameStarted: false,
            playerCount: 3,
            players: ['', '', ''], // Bo≈ü stringler ile ba≈ülat
            darkMode: false,
            gameStake: '',
            currentRound: 1,
            selectedPenalty: '',
            penaltyCaller: '',
            roundPenalties: {},
            roundWinner: '',
            i≈ülerKaƒüƒ±tAtan: '',
            jokerIleBitiren: '',
            cezayƒ±S√∂yleyenA√ßamadƒ±: '',
            gameHistory: [],
            playedPenalties: {},
            customPenalties: [],
            gameStartDate: null,
            // Penalty Management
            activePenalties: [], // Oyunda kullanƒ±lacak aktif cezalar
            penaltyManagementOpen: false
        };

        let defaultPenalties = [
            { id: 1, name: "3S", short: "3S", symbol: "‚ë†", isCustom: false },
            { id: 2, name: "3K", short: "3K", symbol: "‚ë°", isCustom: false },
            { id: 3, name: "3S3K", short: "3S3K", symbol: "‚ë¢", isCustom: false },
            { id: 4, name: "23S", short: "23S", symbol: "‚ë£", isCustom: false },
            { id: 5, name: "23K", short: "23K", symbol: "‚ë§", isCustom: false },
            { id: 6, name: "4S", short: "4S", symbol: "‚ë•", isCustom: false },
            { id: 7, name: "4K", short: "4K", symbol: "‚ë¶", isCustom: false },
            { id: 8, name: "4S4K", short: "4S4K", symbol: "‚ëß", isCustom: false },
            { id: 9, name: "24S", short: "24S", symbol: "‚ë®", isCustom: false },
            { id: 10, name: "24K", short: "24K", symbol: "‚ë©", isCustom: false },
            { id: 11, name: "5S", short: "5S", symbol: "‚ë™", isCustom: false },
            { id: 12, name: "√á", short: "√á", symbol: "‚ë´", isCustom: false },
            { id: 13, name: "E", short: "E", symbol: "‚ë¨", isCustom: false }
        ];

        // Preset difficult penalties
        let difficultPenalties = [
            { id: 14, name: "5√á", short: "5√á", symbol: "‚ë≠", isCustom: false, isDifficult: true },
            { id: 15, name: "6√á", short: "6√á", symbol: "‚ëÆ", isCustom: false, isDifficult: true },
            { id: 16, name: "7√á", short: "7√á", symbol: "‚ëØ", isCustom: false, isDifficult: true },
            { id: 17, name: "34K", short: "34K", symbol: "‚ë∞", isCustom: false, isDifficult: true },
            { id: 18, name: "34S", short: "34S", symbol: "‚ë±", isCustom: false, isDifficult: true },
            { id: 19, name: "7S", short: "7S", symbol: "‚ë≤", isCustom: false, isDifficult: true },
            { id: 20, name: "8S", short: "8S", symbol: "‚ë≥", isCustom: false, isDifficult: true },
            { id: 21, name: "43K", short: "43K", symbol: "„âë", isCustom: false, isDifficult: true },
            { id: 22, name: "43S", short: "43S", symbol: "„âí", isCustom: false, isDifficult: true },
            { id: 23, name: "33S1K", short: "33S1K", symbol: "„âì", isCustom: false, isDifficult: true },
            { id: 24, name: "33K1S", short: "33K1S", symbol: "„âî", isCustom: false, isDifficult: true }
        ];

        // Translation helper function
        function t(key, fallback = key) {
            const keys = key.split('.');
            let value = translations[gameState.language];
            
            for (const k of keys) {
                if (value && value[k] !== undefined) {
                    value = value[k];
                } else {
                    return fallback || key;
                }
            }
            
            return value || fallback || key;
        }

        // Language toggle function
        function toggleLanguage() {
            gameState.language = gameState.language === 'tr' ? 'en' : 'tr';
            updateLanguageToggle();
            updateAllTexts();
            
            // Save language preference
            try {
                localStorage.setItem('americano_language', gameState.language);
            } catch (error) {
                console.error('Error saving language preference:', error);
            }
        }

        function updateLanguageToggle() {
            // Update both toggles (setup and game)
            const toggles = ['languageToggle', 'languageToggleGame'];
            const trElements = ['langTr', 'langTrGame'];
            const enElements = ['langEn', 'langEnGame'];
            
            toggles.forEach((toggleId, index) => {
                const toggle = document.getElementById(toggleId);
                const trElement = document.getElementById(trElements[index]);
                const enElement = document.getElementById(enElements[index]);
                
                if (toggle && trElement && enElement) {
                    if (gameState.language === 'tr') {
                        trElement.className = 'language-option active';
                        enElement.className = `language-option inactive ${gameState.darkMode ? 'dark' : ''}`;
                    } else {
                        trElement.className = `language-option inactive ${gameState.darkMode ? 'dark' : ''}`;
                        enElement.className = 'language-option active';
                    }
                    
                    // Update toggle background for dark mode
                    if (gameState.darkMode) {
                        toggle.classList.add('dark');
                    } else {
                        toggle.classList.remove('dark');
                    }
                }
            });
        }

        function updateAllTexts() {
            // Update setup screen texts
            document.getElementById('setupTitle').textContent = t('gameSetupTitle');
            document.getElementById('setupSubtitle').textContent = t('gameSetupSubtitle');
            document.getElementById('playerCountTitle').textContent = t('playerCount');
            document.getElementById('playerCountDesc').textContent = t('playerCountDesc');
            document.getElementById('playerNamesTitle').textContent = t('playerNames');
            
            // Penalty Management
            document.getElementById('penaltyManagementTitle').textContent = `üéØ ${t('managePenalties')}`;
            document.getElementById('penaltyManagementDesc').textContent = t('selectPenaltiesToPlay');
            document.getElementById('activePenaltyLabel').textContent = `${t('penaltyCount')} ${t('penaltiesSelected').toLowerCase()}`;
            document.getElementById('managePenaltiesBtnText').textContent = t('managePenalties');
            
            document.getElementById('gameStakeTitle').textContent = t('gameStakeTitle');
            document.getElementById('gameStakeInput').placeholder = t('gameStakePlaceholder');
            document.getElementById('startGameBtn').innerHTML = t('startGame');
            document.getElementById('startGameError').textContent = t('fillAllFields');
            document.getElementById('thisGameLabel').textContent = t('thisGame');
            
            // Update stake buttons
            document.getElementById('coffeeBtn').innerHTML = `‚òï ${t('coffee').split(' ')[0]}`;
            document.getElementById('foodBtn').innerHTML = `üçï ${t('food').split(' ')[0]}`;
            document.getElementById('icecreamBtn').innerHTML = `üç¶ ${t('icecream').split(' ')[0]}`;
            document.getElementById('funBtn').innerHTML = `üéâ ${t('fun').split(' ')[0] === 'Sadece' ? 'Eƒülence' : 'Fun'}`;
            document.getElementById('moneyBtn').innerHTML = `üí∞ ${t('money')}`;
            document.getElementById('customBtn').innerHTML = `‚úèÔ∏è ${t('custom')}`;
            
            // Update penalty management modal texts
            document.getElementById('penaltyManagementModalTitle').textContent = `üéØ ${t('managePenalties')}`;
            document.getElementById('penaltyCountLabel').textContent = `${t('penaltyCount')} ${t('penaltiesSelected').toLowerCase()}`;
            document.getElementById('penaltyWarningText').textContent = t('exactly13Required');
            document.getElementById('defaultPenaltiesTitle').textContent = `üìã ${t('defaultPenalties')}`;
            document.getElementById('difficultPenaltiesTitle').textContent = `üß† ${t('difficultPenalties')}`;
            document.getElementById('difficultPenaltiesDesc').textContent = gameState.language === 'tr' ? 'Daha zorlu oyun deneyimi i√ßin √∂zel cezalar' : 'Special penalties for more challenging gameplay';
            document.getElementById('customPenaltiesTitle').textContent = `‚ö° ${t('customPenalties')}`;
            document.getElementById('addNewPenaltyText').textContent = t('addNewPenalty');
            document.getElementById('noCustomPenaltiesText').textContent = gameState.language === 'tr' ? 'Hen√ºz √∂zel ceza eklenmemi≈ü' : 'No custom penalties added yet';
            document.getElementById('addCustomPenaltyHint').textContent = gameState.language === 'tr' ? 'Yukarƒ±daki butona tƒ±klayarak yeni ceza ekleyebilirsiniz' : 'Click the button above to add a new penalty';
            document.getElementById('resetDefaultsText').textContent = t('resetToDefaults');
            document.getElementById('applyPenaltiesText').textContent = t('applyPenalties');
            
            // Add penalty modal texts
            document.getElementById('addPenaltyModalTitle').textContent = `‚ûï ${t('addNewPenalty')}`;
            document.getElementById('penaltyNameLabel').textContent = `${t('penaltyName')}:`;
            document.getElementById('penaltyShortLabel').textContent = `${t('penaltyShort')}:`;
            document.getElementById('penaltySymbolLabel').textContent = `${t('penaltySymbol')}:`;
            document.getElementById('newPenaltyName').placeholder = gameState.language === 'tr' ? "√ñrnek: 6'lƒ± Seri" : "Example: 6-Card Sequence";
            document.getElementById('newPenaltyShort').placeholder = gameState.language === 'tr' ? "√ñrnek: 6S" : "Example: 6S";
            document.getElementById('newPenaltySymbol').placeholder = t('autoGenerated');
            document.getElementById('addPenaltyNote').innerHTML = `<strong>${gameState.language === 'tr' ? 'Not' : 'Note'}:</strong> ${t('penaltyNote')}`;
            document.getElementById('cancelAddPenalty').textContent = t('cancel');
            document.getElementById('submitAddPenalty').textContent = t('addPenalty');
            
            // Update game screen texts
            document.getElementById('roundLabel').textContent = t('round');
            document.getElementById('penaltiesLeftLabel').textContent = t('penaltiesLeft');
            document.getElementById('thisGameLabelGame').textContent = t('thisGame');
            document.getElementById('roundInputLabel').textContent = t('round');
            document.getElementById('scoreInputLabel').textContent = t('scoreInput');
            document.getElementById('penaltyPlayedLabel').textContent = t('penaltyPlayed');
            document.getElementById('selectPenaltyOption').textContent = t('selectPenalty');
            document.getElementById('penaltyCallerLabel').textContent = t('penaltyCaller');
            document.getElementById('selectPlayerOption').textContent = t('selectPlayer');
            document.getElementById('calculateBtnText').textContent = t('fillAllRequiredFields');
            
            // Update buttons
            document.getElementById('historyBtnText').textContent = t('gameHistory');
            document.getElementById('rulesBtnText').textContent = t('readRules');
            document.getElementById('settingsBtnText').textContent = t('playerSettings');
            document.getElementById('newGameBtnText').textContent = t('newGame');
            
            // Update modal titles
            document.getElementById('gameHistoryModalTitle').textContent = t('gameHistoryModalTitle');
            document.getElementById('gameDetailModalTitle').textContent = t('gameDetailModalTitle');
            
            // Update game over
            document.getElementById('gameOverTitle').innerHTML = `üéâ ${t('gameOver')} üéâ`;
            
            // Update other elements
            document.getElementById('scoreTableTitle').textContent = t('scoreTable');
            document.getElementById('remainingPenaltiesTitle').textContent = t('remainingPenalties');
            
            // Update game rules
            updateGameRules();
            
            // If penalty management is open, update it
            if (gameState.penaltyManagementOpen) {
                updatePenaltyManagementModal();
            }
            
            // If game is started, update dynamic content while preserving values
            if (gameState.gameStarted) {
                updateGameScreen();
            }
            
            // Update player inputs
            updatePlayerInputs();
        }

        function updateGameRules() {
            const rulesList = document.getElementById('gameRulesList');
            const rules = gameState.language === 'tr' ? [
                '‚Ä¢ <strong>3, 4 veya 5 oyuncuyla</strong> oynanƒ±r',
                '‚Ä¢ <strong>13 farklƒ± ceza</strong> t√ºr√º vardƒ±r',
                '‚Ä¢ <strong>"Elden" cezasƒ±</strong> mecburen son elde (13. el) oynanƒ±r',
                '‚Ä¢ <strong>Cezayƒ± s√∂yleyen VE bitiren</strong> aynƒ± ki≈üiyse +50 puan',
                '‚Ä¢ <strong>Cezayƒ± s√∂yleyen ba≈üarƒ±sƒ±z:</strong> G√∂revini yapamadan (a√ßamadan) ba≈ükasƒ± bitirirse x2 ceza puanƒ± alƒ±r',
                '‚Ä¢ <strong>Son elde (Elden) bonus yok:</strong> Cezayƒ± s√∂yleyip bitiren +50 alamaz',
                '‚Ä¢ <strong>ƒ∞≈üler kaƒüƒ±t atan</strong> oyuncu -50 ceza puanƒ± alƒ±r',
                '‚Ä¢ <strong>Joker ile bitiren</strong> herkese x2 ceza puanƒ± yedirir',
                '‚Ä¢ <strong>Kazanma:</strong> En y√ºksek puan kazanƒ±r (eksi puanlarda en d√º≈ü√ºk eksi puan)'
            ] : [
                '‚Ä¢ Played with <strong>3, 4 or 5 players</strong>',
                '‚Ä¢ There are <strong>13 different penalty</strong> types',
                '‚Ä¢ <strong>"Going Out" penalty</strong> must be played in the last round (13th round)',
                '‚Ä¢ <strong>Penalty caller AND finisher</strong> gets +50 points if same person',
                '‚Ä¢ <strong>Failed penalty caller:</strong> Gets x2 penalty points if someone else finishes before completing',
                '‚Ä¢ <strong>No bonus in last round:</strong> Caller who finishes "Going Out" cannot get +50 bonus',
                '‚Ä¢ <strong>Useless card thrower</strong> gets -50 penalty points',
                '‚Ä¢ <strong>Joker finisher</strong> gives everyone x2 penalty points',
                '‚Ä¢ <strong>Winning:</strong> Highest score wins (lowest negative score in case of negative points)'
            ];
            
            rulesList.innerHTML = rules.join('\n');
        }

        // Get all penalties (default + difficult + custom)
        function getAllPenalties() {
            return [...defaultPenalties, ...difficultPenalties, ...gameState.customPenalties].map(penalty => ({
                ...penalty,
                displayName: t(`penalties.${penalty.short}`, penalty.name)
            }));
        }

        // Get active penalties for game
        function getActivePenalties() {
            if (gameState.activePenalties.length === 0) {
                // Default: all default penalties
                gameState.activePenalties = [...defaultPenalties.map(p => p.id)];
            }
            return getAllPenalties().filter(p => gameState.activePenalties.includes(p.id));
        }

        // Initialize the app
        function initApp() {
            loadLanguagePreference();
            loadCustomPenalties();
            
            // Initialize active penalties with defaults
            if (gameState.activePenalties.length === 0) {
                gameState.activePenalties = [...defaultPenalties.map(p => p.id)];
            }
            
            updatePlayerInputs();
            updatePlayerCount();
            updateStartButton();
            updateLanguageToggle();
            updateAllTexts();
            updateActivePenaltyDisplay();
            initEventListeners();
        }

        function loadLanguagePreference() {
            try {
                const saved = localStorage.getItem('americano_language');
                if (saved && (saved === 'tr' || saved === 'en')) {
                    gameState.language = saved;
                }
            } catch (error) {
                console.error('Error loading language preference:', error);
            }
        }

        function loadCustomPenalties() {
            try {
                const saved = localStorage.getItem('americano_custom_penalties');
                if (saved) {
                    gameState.customPenalties = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading custom penalties:', error);
                gameState.customPenalties = [];
            }
        }

        // Penalty Management Functions
        function openPenaltyManagement() {
            gameState.penaltyManagementOpen = true;
            updatePenaltyManagementModal();
            document.getElementById('penaltyManagementModal').classList.remove('hidden');
        }

        function closePenaltyManagement() {
            gameState.penaltyManagementOpen = false;
            document.getElementById('penaltyManagementModal').classList.add('hidden');
        }

        function updatePenaltyManagementModal() {
            updateDefaultPenaltiesList();
            updateDifficultPenaltiesList();
            updateCustomPenaltiesList();
            updatePenaltyCount();
            updatePenaltyWarning();
        }

        function updateDefaultPenaltiesList() {
            const container = document.getElementById('defaultPenaltiesList');
            container.innerHTML = '';
            
            defaultPenalties.forEach(penalty => {
                const isActive = gameState.activePenalties.includes(penalty.id);
                const isMandatory = penalty.id === 13; // Elden is mandatory
                
                const div = document.createElement('div');
                div.className = `p-3 border-2 rounded-lg transition-all cursor-pointer ${isActive ? 'border-purple-300 bg-purple-50' : 'border-gray-200 bg-gray-50'}`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    if (!isMandatory) {
                        togglePenalty(penalty.id);
                        updatePenaltyManagementModal();
                    }
                };
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" 
                               ${isActive ? 'checked' : ''} 
                               ${isMandatory ? 'disabled' : ''}
                               onclick="event.stopPropagation()"
                               onchange="togglePenalty(${penalty.id}); updatePenaltyManagementModal()"
                               class="w-5 h-5 text-purple-600 rounded pointer-events-auto" />
                        <span class="${isActive ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'} font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">
                            ${penalty.symbol}
                        </span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">
                                ${t(`penalties.${penalty.short}`, penalty.name)} 
                                ${isMandatory ? `<span class="text-xs text-red-600">${t('goingOutMandatory')}</span>` : ''}
                            </div>
                            <div class="text-xs text-gray-500">(${penalty.short})</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateDifficultPenaltiesList() {
            const container = document.getElementById('difficultPenaltiesList');
            container.innerHTML = '';
            
            difficultPenalties.forEach(penalty => {
                const isActive = gameState.activePenalties.includes(penalty.id);
                
                const div = document.createElement('div');
                div.className = `p-3 border-2 rounded-lg transition-all cursor-pointer ${isActive ? 'border-orange-300 bg-orange-50' : 'border-gray-200 bg-gray-50'}`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    togglePenalty(penalty.id);
                    updatePenaltyManagementModal();
                };
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" 
                               ${isActive ? 'checked' : ''} 
                               onclick="event.stopPropagation()"
                               onchange="togglePenalty(${penalty.id}); updatePenaltyManagementModal()"
                               class="w-5 h-5 text-orange-600 rounded pointer-events-auto" />
                        <span class="${isActive ? 'bg-orange-100 text-orange-800' : 'bg-gray-100 text-gray-800'} font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">
                            ${penalty.symbol}
                        </span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">
                                ${t(`penalties.${penalty.short}`, penalty.name)} üß†
                            </div>
                            <div class="text-xs text-gray-500">(${penalty.short})</div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateCustomPenaltiesList() {
            const container = document.getElementById('customPenaltiesList');
            const noCustomDiv = document.getElementById('noCustomPenalties');
            
            if (gameState.customPenalties.length === 0) {
                container.classList.add('hidden');
                noCustomDiv.classList.remove('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            noCustomDiv.classList.add('hidden');
            container.innerHTML = '';
            
            gameState.customPenalties.forEach(penalty => {
                const isActive = gameState.activePenalties.includes(penalty.id);
                
                const div = document.createElement('div');
                div.className = `p-3 border-2 rounded-lg transition-all cursor-pointer ${isActive ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'}`;
                div.onclick = (e) => {
                    e.stopPropagation();
                    togglePenalty(penalty.id);
                    updatePenaltyManagementModal();
                };
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <input type="checkbox" 
                               ${isActive ? 'checked' : ''} 
                               onclick="event.stopPropagation()"
                               onchange="togglePenalty(${penalty.id}); updatePenaltyManagementModal()"
                               class="w-5 h-5 text-green-600 rounded pointer-events-auto" />
                        <span class="${isActive ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'} font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">
                            ${penalty.symbol}
                        </span>
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">
                                ${penalty.name} ‚ö°
                            </div>
                            <div class="text-xs text-gray-500">(${penalty.short})</div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCustomPenalty(${penalty.id})" 
                                class="text-red-500 hover:text-red-700 p-1">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function togglePenalty(penaltyId) {
            const index = gameState.activePenalties.indexOf(penaltyId);
            if (index > -1) {
                // Remove penalty (except Elden which is mandatory)
                if (penaltyId !== 13) {
                    gameState.activePenalties.splice(index, 1);
                }
            } else {
                // Add penalty
                gameState.activePenalties.push(penaltyId);
            }
            
            updatePenaltyCount();
            updatePenaltyWarning();
        }

        function updatePenaltyCount() {
            const count = gameState.activePenalties.length;
            document.getElementById('selectedCountDisplay').textContent = count;
            document.getElementById('activePenaltyCount').textContent = count;
        }

        function updatePenaltyWarning() {
            const count = gameState.activePenalties.length;
            const warning = document.getElementById('penaltyWarning');
            const applyBtn = document.getElementById('applyPenaltiesBtn');
            
            if (count !== 13) {
                warning.classList.remove('hidden');
                applyBtn.disabled = true;
                applyBtn.className = 'px-8 py-3 bg-gray-400 text-white font-bold rounded-lg cursor-not-allowed';
            } else {
                warning.classList.add('hidden');
                applyBtn.disabled = false;
                applyBtn.className = 'px-8 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg transition-all';
            }
        }

        function resetToDefaultPenalties() {
            gameState.activePenalties = [...defaultPenalties.map(p => p.id)];
            updatePenaltyManagementModal();
        }

        function applyPenaltySelection() {
            if (gameState.activePenalties.length !== 13) {
                alert(t('exactly13Required'));
                return;
            }
            
            closePenaltyManagement();
            updateActivePenaltyDisplay();
        }

        function updateActivePenaltyDisplay() {
            const count = gameState.activePenalties.length;
            document.getElementById('activePenaltyCount').textContent = count;
        }

        function openAddPenaltyModal() {
            document.getElementById('addPenaltyModal').classList.remove('hidden');
            document.getElementById('newPenaltyName').value = '';
            document.getElementById('newPenaltyShort').value = '';
            updateNewPenaltySymbol();
            
            // Add event listeners for real-time symbol update
            const nameInput = document.getElementById('newPenaltyName');
            const shortInput = document.getElementById('newPenaltyShort');
            
            nameInput.removeEventListener('input', updateNewPenaltySymbol);
            shortInput.removeEventListener('input', updateNewPenaltySymbol);
            nameInput.addEventListener('input', updateNewPenaltySymbol);
            shortInput.addEventListener('input', updateNewPenaltySymbol);
        }

        function closeAddPenaltyModal() {
            document.getElementById('addPenaltyModal').classList.add('hidden');
        }

        function updateNewPenaltySymbol() {
            const nextId = Math.max(...getAllPenalties().map(p => p.id)) + 1;
            const symbol = getSymbolForId(nextId);
            document.getElementById('newPenaltySymbol').value = symbol;
        }

        function getSymbolForId(id) {
            if (id <= 20) {
                return String.fromCharCode(9311 + id); // ‚ë†‚ë°‚ë¢...‚ë≥
            } else {
                return String.fromCharCode(12860 + id - 20); // „âë„âí„âì...
            }
        }

        function saveNewPenalty(event) {
            event.preventDefault();
            
            const name = document.getElementById('newPenaltyName').value.trim();
            const short = document.getElementById('newPenaltyShort').value.trim();
            
            if (!name || !short) {
                alert(gameState.language === 'tr' ? 'L√ºtfen t√ºm alanlarƒ± doldurun!' : 'Please fill all fields!');
                return;
            }
            
            const nextId = Math.max(...getAllPenalties().map(p => p.id)) + 1;
            const symbol = getSymbolForId(nextId);
            
            const newPenalty = {
                id: nextId,
                name: name,
                short: short,
                symbol: symbol,
                isCustom: true
            };
            
            gameState.customPenalties.push(newPenalty);
            saveCustomPenaltiesToStorage();
            
            closeAddPenaltyModal();
            updatePenaltyManagementModal();
        }

        function deleteCustomPenalty(penaltyId) {
            if (confirm(gameState.language === 'tr' ? 'Bu cezayƒ± silmek istediƒüinizden emin misiniz?' : 'Are you sure you want to delete this penalty?')) {
                gameState.customPenalties = gameState.customPenalties.filter(p => p.id !== penaltyId);
                gameState.activePenalties = gameState.activePenalties.filter(id => id !== penaltyId);
                saveCustomPenaltiesToStorage();
                updatePenaltyManagementModal();
            }
        }

        function saveCustomPenaltiesToStorage() {
            try {
                localStorage.setItem('americano_custom_penalties', JSON.stringify(gameState.customPenalties));
            } catch (error) {
                console.error('Error saving custom penalties:', error);
            }
        }

        function initEventListeners() {
            document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
            document.getElementById('removePlayerBtn').addEventListener('click', removePlayer);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('gameStakeInput').addEventListener('input', updateGameStake);
        }

        function addPlayer() {
            if (gameState.playerCount < 5) {
                gameState.playerCount++;
                gameState.players.push(''); // Bo≈ü string ile ba≈ülat
                updatePlayerInputs();
                updatePlayerCount();
                updateStartButton();
            }
        }

        function removePlayer() {
            if (gameState.playerCount > 3) {
                gameState.playerCount--;
                gameState.players.pop();
                updatePlayerInputs();
                updatePlayerCount();
                updateStartButton();
            }
        }

        function updatePlayerCount() {
            document.getElementById('playerCountDisplay').textContent = gameState.playerCount;
            
            const removeBtn = document.getElementById('removePlayerBtn');
            const addBtn = document.getElementById('addPlayerBtn');
            
            if (gameState.playerCount <= 3) {
                removeBtn.className = 'p-3 rounded-lg font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
            } else {
                removeBtn.className = 'p-3 rounded-lg font-bold transition-all bg-red-500 text-white hover:bg-red-600';
            }
            
            if (gameState.playerCount >= 5) {
                addBtn.className = 'p-3 rounded-lg font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
            } else {
                addBtn.className = 'p-3 rounded-lg font-bold transition-all bg-green-500 text-white hover:bg-green-600';
            }
        }

        function updatePlayerInputs() {
            const container = document.getElementById('playerInputs');
            const gridClass = gameState.playerCount === 3 ? 'grid-cols-3' : 
                             gameState.playerCount === 4 ? 'grid-cols-2 md:grid-cols-4' : 
                             'grid-cols-2 md:grid-cols-3 lg:grid-cols-5';
            
            container.className = `grid gap-4 ${gridClass}`;
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'rounded-lg p-4 bg-white';
                playerDiv.innerHTML = `
                    <label class="block text-sm font-medium mb-2 text-gray-700">${t('player')} ${index + 1}</label>
                    <input type="text" value="${player}" onchange="updatePlayerName(${index}, this.value)"
                           class="w-full p-3 border border-gray-300 rounded-lg text-center font-medium text-lg bg-white text-black placeholder-gray-400"
                           placeholder="${t('player')} ${index + 1}" />
                `;
                container.appendChild(playerDiv);
            });
        }

        function updatePlayerName(index, name) {
            gameState.players[index] = name;
            updateStartButton();
        }

        function updateStartButton() {
            const allFilled = gameState.players.every(player => player.trim() !== '');
            const startBtn = document.getElementById('startGameBtn');
            const errorDiv = document.getElementById('startGameError');
            
            if (allFilled) {
                startBtn.className = 'px-8 py-4 rounded-lg font-bold text-white text-xl transition-all bg-purple-600 hover:bg-purple-700 hover:scale-105';
                errorDiv.classList.add('hidden');
            } else {
                startBtn.className = 'px-8 py-4 rounded-lg font-bold text-white text-xl transition-all bg-gray-400 cursor-not-allowed';
                errorDiv.classList.remove('hidden');
            }
        }

        function setStake(stakeKey) {
            gameState.gameStake = t(stakeKey);
            document.getElementById('gameStakeInput').value = gameState.gameStake;
            updateGameStakeDisplay();
        }

        function setCustomStake() {
            const custom = prompt(gameState.language === 'tr' ? '√ñzel iddia yazƒ±n:' : 'Enter custom stake:');
            if (custom) {
                gameState.gameStake = custom;
                document.getElementById('gameStakeInput').value = custom;
                updateGameStakeDisplay();
            }
        }

        function updateGameStake() {
            gameState.gameStake = document.getElementById('gameStakeInput').value;
            updateGameStakeDisplay();
        }

        function updateGameStakeDisplay() {
            const display = document.getElementById('gameStakeDisplay');
            const text = document.getElementById('gameStakeText');
            
            if (gameState.gameStake) {
                text.textContent = gameState.gameStake;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function startGame() {
            startGameFromSetup();
        }

        function backToSetup() {
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
        }

        function startGameFromSetup() {
            const allFilled = gameState.players.every(player => player.trim() !== '');
            if (!allFilled) return;
            
            if (gameState.gameStarted) {
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                updateGameScreen();
                return;
            }
            
            gameState.gameStarted = true;
            gameState.gameStartDate = new Date().toLocaleString(gameState.language === 'tr' ? 'tr-TR' : 'en-US');
            gameState.roundPenalties = {};
            gameState.players.forEach(player => {
                gameState.roundPenalties[player] = '';
            });
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateGameScreen();
        }

        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            const app = document.getElementById('app');
            const gameScreen = document.getElementById('gameScreen');
            const setupScreen = document.getElementById('setupScreen');
            const btn = document.getElementById('darkModeBtn');
            
            if (gameState.darkMode) {
                app.className = 'max-w-7xl mx-auto p-6 min-h-screen transition-colors bg-gray-900';
                if (gameScreen) gameScreen.className = gameScreen.className.replace('bg-white', 'bg-gray-800 text-white');
                if (setupScreen) {
                    const setupCard = setupScreen.querySelector('.bg-white');
                    if (setupCard) setupCard.className = setupCard.className.replace('bg-white', 'bg-gray-800 text-white');
                }
                btn.textContent = '‚òÄÔ∏è';
                btn.title = gameState.language === 'tr' ? 'G√ºnd√ºz modu' : 'Light mode';
                btn.className = 'ml-2 p-2 rounded-lg transition-all bg-yellow-500 text-gray-900 hover:bg-yellow-400';
            } else {
                app.className = 'max-w-7xl mx-auto p-6 min-h-screen transition-colors bg-gradient-to-br from-purple-50 to-blue-100';
                if (gameScreen) gameScreen.className = gameScreen.className.replace('bg-gray-800 text-white', 'bg-white');
                if (setupScreen) {
                    const setupCard = setupScreen.querySelector('.bg-gray-800');
                    if (setupCard) setupCard.className = setupCard.className.replace('bg-gray-800 text-white', 'bg-white');
                }
                btn.textContent = 'üåô';
                btn.title = gameState.language === 'tr' ? 'Gece modu' : 'Dark mode';
                btn.className = 'ml-2 p-2 rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
            }
            
            updateLanguageToggle();
        }

        function updateGameScreen() {
            document.getElementById('playersDisplay').textContent = gameState.players.join(' - ');
            document.getElementById('currentRoundDisplay').textContent = gameState.currentRound;
            document.getElementById('roundInputTitle').textContent = gameState.currentRound;
            
            updateRemainingPenalties();
            updateScoreCards();
            
            // Se√ßili deƒüerleri koru
            const selectedPenaltyValue = gameState.selectedPenalty;
            const selectedCallerValue = gameState.penaltyCaller;
            
            updatePenaltySelector();
            updatePlayerSelector();
            
            // Deƒüerleri geri y√ºkle
            if (selectedPenaltyValue) {
                const penaltySelect = document.getElementById('selectedPenalty');
                penaltySelect.value = selectedPenaltyValue;
                gameState.selectedPenalty = selectedPenaltyValue;
            }
            
            if (selectedCallerValue) {
                const callerSelect = document.getElementById('penaltyCaller');
                callerSelect.value = selectedCallerValue;
                gameState.penaltyCaller = selectedCallerValue;
            }
            
            updatePlayerInputCards();
            updateGameStakeGameDisplay();
        }

        function updateGameStakeGameDisplay() {
            const display = document.getElementById('gameStakeGameDisplay');
            const text = document.getElementById('gameStakeGameText');
            
            if (gameState.gameStake) {
                text.textContent = gameState.gameStake;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function getRemainingPenalties() {
            return getActivePenalties().filter(p => !gameState.playedPenalties[p.id]);
        }

        function getAvailablePenalties() {
            const available = getRemainingPenalties();
            if (available.length > 1 && available.some(p => p.id === 13)) {
                return available.filter(penalty => penalty.id !== 13);
            }
            return available;
        }

        function getCurrentScores() {
            const scores = {};
            gameState.players.forEach(player => {
                scores[player] = 0;
            });
            
            gameState.gameHistory.forEach(round => {
                round.results.forEach(result => {
                    scores[result.player] += result.totalChange;
                });
            });
            
            return scores;
        }

        function getLeader() {
            const scores = getCurrentScores();
            const maxScore = Math.max(...Object.values(scores));
            if (maxScore <= 0) return null;
            return Object.keys(scores).find(player => scores[player] === maxScore);
        }

        function updateScoreCards() {
            const scores = getCurrentScores();
            const leader = getLeader();
            const container = document.getElementById('scoreCards');
            const gridClass = 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
            
            container.className = `grid gap-4 mb-8 ${gridClass}`;
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const score = scores[player] || 0;
                const scoreClass = score >= 0 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                
                const div = document.createElement('div');
                div.className = 'rounded-xl p-6 border text-center bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200 w-full';
                div.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-gray-800">${player}</h3>
                    <div class="text-3xl font-bold rounded-lg py-3 px-4 shadow-inner ${scoreClass}">
                        ${score > 0 ? '+' : ''}${score}
                    </div>
                    <div class="text-sm mt-1 text-gray-500">${t('totalScore')}</div>
                `;
                container.appendChild(div);
            });
            
            const leaderBanner = document.getElementById('leaderBanner');
            const leaderText = document.getElementById('leaderText');
            
            if (leader) {
                leaderText.textContent = `${t('leader')}: ${leader} (${scores[leader]} ${t('points')})`;
                leaderBanner.classList.remove('hidden');
            } else {
                leaderBanner.classList.add('hidden');
            }
        }

        function updatePenaltySelector() {
            const select = document.getElementById('selectedPenalty');
            const remaining = getRemainingPenalties();
            const available = getAvailablePenalties();
            
            select.innerHTML = `<option value="">${t('selectPenalty')}</option>`;
            
            if (remaining.length === 1 && remaining[0].id === 13) {
                select.innerHTML = '';
                const option = document.createElement('option');
                option.value = '13';
                option.textContent = `‚ë¨ ${t('penalties.E')} (${gameState.language === 'tr' ? 'Son El - Mecburi' : 'Last Round - Mandatory'})`;
                option.selected = true;
                select.appendChild(option);
                select.style.backgroundColor = '#fef2f2';
                select.style.color = '#b91c1c';
                gameState.selectedPenalty = '13';
            } else {
                available.forEach(penalty => {
                    const option = document.createElement('option');
                    option.value = penalty.id;
                    option.textContent = `${penalty.symbol} ${penalty.displayName} (${penalty.short})`;
                    select.appendChild(option);
                });
                select.style.backgroundColor = '';
                select.style.color = '';
            }
            
            select.style.fontSize = '18px';
            select.style.padding = '16px';
            
            // Event listener'ƒ± yeniden ekle
            select.removeEventListener('change', handlePenaltyChange);
            select.addEventListener('change', handlePenaltyChange);
        }

        function handlePenaltyChange(event) {
            gameState.selectedPenalty = event.target.value;
            updateCalculateButton();
        }

        function updatePlayerSelector() {
            const select = document.getElementById('penaltyCaller');
            select.className = 'w-full p-4 md:p-3 text-lg md:text-lg min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg font-medium';
            select.style.fontSize = '18px';
            select.style.padding = '16px';
            select.innerHTML = `<option value="">${t('selectPlayer')}</option>`;
            
            gameState.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                select.appendChild(option);
            });
            
            // Event listener'ƒ± yeniden ekle
            select.removeEventListener('change', handlePlayerCallerChange);
            select.addEventListener('change', handlePlayerCallerChange);
        }

        function handlePlayerCallerChange(event) {
            gameState.penaltyCaller = event.target.value;
            updatePlayerInputCards();
            updateCalculateButton();
        }

        function updatePlayerInputCards() {
            const container = document.getElementById('playerInputCards');
            const gridClass = gameState.playerCount === 3 ? 'grid-cols-3' : 
                             gameState.playerCount === 4 ? 'grid-cols-2 md:grid-cols-4' : 
                             'grid-cols-2 md:grid-cols-3 lg:grid-cols-5';
            
            container.className = `grid gap-4 mb-6 ${gridClass}`;
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-lg p-4';
                
                const isWinner = gameState.roundWinner === player;
                const penaltyInput = isWinner ? 
                    `<div class="w-full p-4 border border-gray-200 rounded-xl text-center font-bold text-2xl bg-green-50 text-green-600 h-16 flex items-center justify-center">
                        0 (${t('finishedRound')})
                     </div>` :
                    `<input type="number" min="0" max="13" value="${gameState.roundPenalties[player] || ''}" 
                            onchange="updatePlayerPenalty('${player}', this.value)"
                            class="w-full p-4 border border-gray-300 rounded-xl text-center font-bold text-2xl h-16" placeholder="0" />
                     <div class="text-sm text-gray-500 mt-2 text-center font-medium">
                        <span id="penalty-preview-${player}">-${gameState.roundPenalties[player] || 0} ${t('points')}</span>
                     </div>`;
                
                div.innerHTML = `
                    <h4 class="font-semibold text-center mb-3">${player}</h4>
                    
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">${t('thisRoundPenalty')}</label>
                        ${penaltyInput}
                    </div>
                    
                    <button onclick="toggleRoundWinner('${player}')" 
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all mb-2 ${isWinner ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                        ${isWinner ? `‚úì ${t('finishedRound')}` : t('finishedRound')}
                    </button>
                    
                    <button onclick="toggleJokerWinner('${player}')" 
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all mb-2 ${gameState.jokerIleBitiren === player ? 'bg-orange-500 text-white shadow-lg' : 'bg-orange-100 text-orange-700 hover:bg-orange-200'}">
                        ${gameState.jokerIleBitiren === player ? `‚úì ${t('finishedWithJoker')}` : t('finishedWithJoker')}
                    </button>
                    
                    <button onclick="toggleIslerKagit('${player}')" 
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all mb-2 ${gameState.i≈ülerKaƒüƒ±tAtan === player ? 'bg-red-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                        ${gameState.i≈ülerKaƒüƒ±tAtan === player ? `‚úì ${t('threwUselessCard')}` : t('threwUselessCard')}
                    </button>
                    
                    <button onclick="toggleFailedCaller('${player}')" 
                            ${gameState.penaltyCaller !== player ? 'disabled' : ''}
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all ${gameState.penaltyCaller !== player 
                                ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                : gameState.cezayƒ±S√∂yleyenA√ßamadƒ± === player
                                ? 'bg-purple-500 text-white shadow-lg'
                                : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}">
                        ${gameState.penaltyCaller !== player 
                            ? t('onlyForCaller')
                            : gameState.cezayƒ±S√∂yleyenA√ßamadƒ± === player ? `‚úì ${t('failedToComplete')}` : t('failedToComplete')
                        }
                    </button>
                    
                    <div id="status-${player}" class="text-center text-xs font-medium mt-1">
                        ${getPlayerStatus(player)}
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            updatePenaltyPreviews();
        }

        function getPlayerStatus(player) {
            const isWinner = gameState.roundWinner === player;
            const isCaller = gameState.penaltyCaller === player;
            const isJoker = gameState.jokerIleBitiren === player;
            const isIsler = gameState.i≈ülerKaƒüƒ±tAtan === player;
            const isFailed = gameState.cezayƒ±S√∂yleyenA√ßamadƒ± === player;
            
            let status = [];
            
            if (isWinner && isCaller && gameState.selectedPenalty !== '13') {
                status.push(`<div class="text-green-600">${t('bonusPoints')}</div>`);
            } else if (isWinner && isCaller && gameState.selectedPenalty === '13') {
                status.push(`<div class="text-gray-500">${t('noLastRoundBonus')}</div>`);
            }
            
            if (isJoker) {
                status.push(`<div class="text-orange-600">${t('jokerEffect')}</div>`);
            }
            
            if (isIsler) {
                status.push(`<div class="text-red-600">${t('uselessCardPenalty')}</div>`);
            }
            
            if (isFailed) {
                status.push(`<div class="text-purple-600">${t('failedCallerPenalty')}</div>`);
            }
            
            return status.join('');
        }

        function updatePlayerPenalty(player, value) {
            gameState.roundPenalties[player] = value;
            updatePenaltyPreviews();
            updateCalculateButton();
        }

        function updatePenaltyPreviews() {
            gameState.players.forEach(player => {
                const preview = document.getElementById(`penalty-preview-${player}`);
                if (preview) {
                    const baseValue = parseInt(gameState.roundPenalties[player]) || 0;
                    let multiplier = 1;
                    let effects = [];
                    
                    if (gameState.cezayƒ±S√∂yleyenA√ßamadƒ± === player && gameState.cezayƒ±S√∂yleyenA√ßamadƒ± !== '') {
                        multiplier *= 2;
                        effects.push(gameState.language === 'tr' ? 'x2 G√∂revini a√ßamadƒ±' : 'x2 Failed to complete');
                    }
                    
                    if (gameState.jokerIleBitiren && gameState.jokerIleBitiren !== '') {
                        multiplier *= 2;
                        effects.push(gameState.language === 'tr' ? 'x2 Joker etkisi' : 'x2 Joker effect');
                    }
                    
                    const finalValue = baseValue * multiplier;
                    
                    if (effects.length > 0) {
                        preview.innerHTML = `<span class="text-red-600 font-bold">-${finalValue} ${t('points')} (${effects.join(' + ')})</span>`;
                    } else {
                        preview.textContent = `-${baseValue} ${t('points')}`;
                    }
                }
            });
        }

        function toggleRoundWinner(player) {
            gameState.roundWinner = gameState.roundWinner === player ? '' : player;
            updatePlayerInputCards();
            updateCalculateButton();
        }

        function toggleJokerWinner(player) {
            gameState.jokerIleBitiren = gameState.jokerIleBitiren === player ? '' : player;
            if (gameState.jokerIleBitiren === player) {
                gameState.roundWinner = player;
            }
            updatePlayerInputCards();
            updateCalculateButton();
        }

        function toggleIslerKagit(player) {
            gameState.i≈ülerKaƒüƒ±tAtan = gameState.i≈ülerKaƒüƒ±tAtan === player ? '' : player;
            updatePlayerInputCards();
        }

        function toggleFailedCaller(player) {
            gameState.cezayƒ±S√∂yleyenA√ßamadƒ± = gameState.cezayƒ±S√∂yleyenA√ßamadƒ± === player ? '' : player;
            updatePlayerInputCards();
            updatePenaltyPreviews();
        }

        function canCalculate() {
            const allPenaltiesFilled = gameState.players.every(player => 
                player === gameState.roundWinner ? true : gameState.roundPenalties[player] !== undefined && gameState.roundPenalties[player] !== ''
            );
            return gameState.selectedPenalty !== '' && gameState.penaltyCaller !== '' && gameState.roundWinner !== '' && allPenaltiesFilled;
        }

        function updateCalculateButton() {
            const btn = document.getElementById('calculateBtn');
            const btnText = document.getElementById('calculateBtnText');
            const canCalc = canCalculate();
            
            if (canCalc) {
                btn.className = 'px-8 py-3 rounded-lg font-bold text-white transition-all bg-purple-600 hover:bg-purple-700 hover:scale-105';
                btnText.textContent = t('calculateRound');
            } else {
                btn.className = 'px-8 py-3 rounded-lg font-bold text-white transition-all bg-gray-400 cursor-not-allowed';
                btnText.textContent = t('fillAllRequiredFields');
            }
            
            updateWarningMessages();
        }

        function updateWarningMessages() {
            const container = document.getElementById('warningMessages');
            container.innerHTML = '';
            
            if (gameState.cezayƒ±S√∂yleyenA√ßamadƒ±) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-purple-100 rounded-lg border border-purple-300';
                div.innerHTML = `
                    <p class="text-purple-800 font-medium">üíú ${t('callerFailedWarning')}</p>
                    <p class="text-sm text-purple-700 mt-1">${gameState.cezayƒ±S√∂yleyenA√ßamadƒ±} ${t('callerFailedDesc')}</p>
                `;
                container.appendChild(div);
            }
            
            if (gameState.selectedPenalty === '13') {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-blue-100 rounded-lg border border-blue-300';
                div.innerHTML = `
                    <p class="text-blue-800 font-medium">‚ö†Ô∏è ${t('lastRoundRule')}</p>
                    <p class="text-sm text-blue-700 mt-1">${t('lastRoundRuleDesc')}</p>
                `;
                container.appendChild(div);
            }
            
            if (gameState.jokerIleBitiren) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-orange-100 rounded-lg border border-orange-300';
                div.innerHTML = `
                    <p class="text-orange-800 font-medium">üÉè ${t('jokerEffectActive')}</p>
                    <p class="text-sm text-orange-700 mt-1">${gameState.jokerIleBitiren} ${t('jokerEffectDesc')}</p>
                `;
                container.appendChild(div);
            }
            
            if (!canCalculate()) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-yellow-100 rounded-lg border border-yellow-300';
                const missing = [];
                
                if (!gameState.selectedPenalty) missing.push(t('selectPlayedPenalty'));
                if (!gameState.penaltyCaller) missing.push(t('selectPenaltyCaller'));
                if (!gameState.roundWinner) missing.push(t('selectRoundWinner'));
                
                const allPenaltiesFilled = gameState.players.every(player => 
                    player === gameState.roundWinner ? true : gameState.roundPenalties[player] !== undefined && gameState.roundPenalties[player] !== ''
                );
                if (!allPenaltiesFilled) missing.push(t('enterOtherPenalties'));
                
                div.innerHTML = `
                    <p class="text-yellow-800 font-medium">${t('missingFields')}</p>
                    <ul class="text-sm text-yellow-700 mt-2">
                        ${missing.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                `;
                container.appendChild(div);
            }
        }

        function updateRemainingPenalties() {
            const remaining = getRemainingPenalties();
            document.getElementById('remainingPenaltiesDisplay').textContent = remaining.length;
            document.getElementById('remainingCount').textContent = remaining.length;
            
            const container = document.getElementById('remainingPenalties');
            container.innerHTML = '';
            
            const available = getAvailablePenalties();
            
            if (available.length > 0) {
                available.forEach(penalty => {
                    const div = document.createElement('div');
                    div.className = `bg-white p-3 rounded-lg border-2 transition-all ${penalty.isCustom ? 'border-purple-200 hover:border-purple-400' : 'border-yellow-200 hover:border-yellow-400'}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="${penalty.isCustom ? 'bg-purple-100 text-purple-800' : 'bg-yellow-100 text-yellow-800'} font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">
                                ${penalty.symbol}
                            </span>
                            <div>
                                <div class="font-medium text-gray-800">${penalty.displayName} ${penalty.isCustom ? '‚ö°' : ''}</div>
                                <div class="text-xs text-gray-500">(${penalty.short})</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                if (!gameState.playedPenalties[13] && available.length > 0) {
                    const eldenDiv = document.createElement('div');
                    eldenDiv.className = 'bg-red-50 p-3 rounded-lg border-2 border-red-200';
                    eldenDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">‚ë¨</span>
                            <div>
                                <div class="font-medium text-red-700">${t('penalties.E')}</div>
                                <div class="text-xs text-red-500">(E) - ${gameState.language === 'tr' ? 'Son elde mecburi' : 'Mandatory in last round'}</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(eldenDiv);
                }
            } else {
                const message = document.createElement('div');
                message.className = 'text-center text-gray-500 py-4';
                const messageText = remaining.length === 1 ? 
                    (gameState.language === 'tr' ? 'Son el - Sadece "Elden" kaldƒ±! üéØ' : 'Last round - Only "Going Out" left! üéØ') :
                    (gameState.language === 'tr' ? 'T√ºm cezalar oynandƒ±! üéâ' : 'All penalties played! üéâ');
                message.innerHTML = `<p class="text-lg">${messageText}</p>`;
                container.appendChild(message);
            }
        }

        function calculateRoundScore() {
            if (!canCalculate()) return;
            
            const scores = getCurrentScores();
            const roundResults = [];
            const allPenalties = getActivePenalties(); // Use active penalties instead of all penalties
            const penalty = allPenalties.find(p => p.id === parseInt(gameState.selectedPenalty));

            gameState.players.forEach(player => {
                let originalPenalty = parseInt(gameState.roundPenalties[player]) || 0;
                let penaltyCount = originalPenalty;
                
                if (player === gameState.cezayƒ±S√∂yleyenA√ßamadƒ± && gameState.cezayƒ±S√∂yleyenA√ßamadƒ± !== '') {
                    penaltyCount = originalPenalty * 2;
                }
                
                if (gameState.jokerIleBitiren && gameState.jokerIleBitiren !== '') {
                    if (player === gameState.cezayƒ±S√∂yleyenA√ßamadƒ± && gameState.cezayƒ±S√∂yleyenA√ßamadƒ± !== '') {
                        penaltyCount = originalPenalty * 2 * 2;
                    } else {
                        penaltyCount = originalPenalty * 2;
                    }
                }
                
                if (player === gameState.roundWinner) {
                    penaltyCount = 0;
                    originalPenalty = 0;
                }
                
                let bonusPoints = 0;
                const isLastRound = gameState.selectedPenalty === '13';
                if (player === gameState.roundWinner && player === gameState.penaltyCaller && !isLastRound) {
                    bonusPoints = 50;
                }
                
                const i≈ülerKaƒüƒ±tCezasƒ± = player === gameState.i≈ülerKaƒüƒ±tAtan ? -50 : 0;
                const totalChange = -penaltyCount + bonusPoints + i≈ülerKaƒüƒ±tCezasƒ±;
                
                roundResults.push({
                    player,
                    penalties: penaltyCount,
                    originalPenalties: originalPenalty,
                    bonus: bonusPoints,
                    i≈ülerKaƒüƒ±tCezasƒ±: i≈ülerKaƒüƒ±tCezasƒ±,
                    totalChange: totalChange,
                    newTotal: scores[player] + totalChange,
                    isWinner: player === gameState.roundWinner,
                    gotBonus: bonusPoints > 0,
                    attƒ±ƒ∞≈ülerKaƒüƒ±t: player === gameState.i≈ülerKaƒüƒ±tAtan,
                    jokerEtkisi: gameState.jokerIleBitiren && gameState.jokerIleBitiren !== '',
                    cezayƒ±S√∂yleyenA√ßamadƒ±: player === gameState.cezayƒ±S√∂yleyenA√ßamadƒ± && gameState.cezayƒ±S√∂yleyenA√ßamadƒ± !== ''
                });
            });

            gameState.gameHistory.push({
                round: gameState.currentRound,
                penaltyId: penalty.id,
                penaltyName: penalty.displayName,
                penaltyShort: penalty.short,
                penaltySymbol: penalty.symbol,
                penaltyCaller: gameState.penaltyCaller,
                i≈ülerKaƒüƒ±tAtan: gameState.i≈ülerKaƒüƒ±tAtan,
                jokerIleBitiren: gameState.jokerIleBitiren,
                cezayƒ±S√∂yleyenA√ßamadƒ±: gameState.cezayƒ±S√∂yleyenA√ßamadƒ±,
                results: roundResults,
                winner: gameState.roundWinner,
                time: new Date().toLocaleTimeString(gameState.language === 'tr' ? 'tr-TR' : 'en-US')
            });

            gameState.playedPenalties[penalty.id] = true;

            // Reset for next round
            gameState.selectedPenalty = '';
            gameState.penaltyCaller = '';
            gameState.i≈ülerKaƒüƒ±tAtan = '';
            gameState.jokerIleBitiren = '';
            gameState.cezayƒ±S√∂yleyenA√ßamadƒ± = '';
            
            gameState.roundPenalties = {};
            gameState.players.forEach(player => {
                gameState.roundPenalties[player] = '';
            });
            gameState.roundWinner = '';
            gameState.currentRound++;
            
            // Selector'larƒ± sƒ±fƒ±rla
            const penaltySelect = document.getElementById('selectedPenalty');
            const callerSelect = document.getElementById('penaltyCaller');
            if (penaltySelect) penaltySelect.value = '';
            if (callerSelect) callerSelect.value = '';
            
            updateGameScreen();
            updateGameHistory();
            checkGameOver();
        }

        function updateGameHistory() {
            if (gameState.gameHistory.length === 0) return;
            
            const section = document.getElementById('gameHistorySection');
            section.classList.remove('hidden');
            
            const thead = document.getElementById('gameHistoryTableHead');
            const tbody = document.getElementById('gameHistoryTableBody');
            
            thead.innerHTML = `
                <tr class="bg-purple-600 text-white">
                    <th class="border p-3 font-bold">${t('round')}</th>
                    <th class="border p-3 font-bold">${t('penalty')} / ${t('caller')}</th>
                    ${gameState.players.map(player => `<th class="border p-3 font-bold">${player}</th>`).join('')}
                </tr>
            `;
            
            tbody.innerHTML = '';
            gameState.gameHistory.forEach((round, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                
                tr.innerHTML = `
                    <td class="border p-3 text-center">
                        <div class="font-bold text-lg text-purple-600">${round.round}</div>
                        <div class="text-xs text-gray-500">${t('round')}</div>
                    </td>
                    <td class="border p-3 font-medium text-center">
                        <div class="font-bold">${round.penaltySymbol}</div>
                        <div class="text-xs text-gray-600">${round.penaltyName}</div>
                        <div class="text-xs text-blue-600 font-medium mt-1">üë§ ${round.penaltyCaller}</div>
                        ${round.i≈ülerKaƒüƒ±tAtan ? `<div class="text-xs text-red-600 font-medium">‚ö†Ô∏è ${round.i≈ülerKaƒüƒ±tAtan}</div>` : ''}
                        ${round.jokerIleBitiren ? `<div class="text-xs text-orange-600 font-medium">üÉè ${round.jokerIleBitiren}</div>` : ''}
                        ${round.cezayƒ±S√∂yleyenA√ßamadƒ± ? `<div class="text-xs text-purple-600 font-medium">üíú ${round.cezayƒ±S√∂yleyenA√ßamadƒ±}</div>` : ''}
                    </td>
                    ${gameState.players.map(player => {
                        const result = round.results.find(r => r.player === player);
                        return `
                            <td class="border p-3 text-center">
                                <div class="font-bold text-lg ${result?.newTotal >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${result?.newTotal || 0}
                                </div>
                                <div class="text-xs text-gray-500">
                                    (${result?.totalChange > 0 ? '+' : ''}${result?.totalChange || 0})
                                    ${result?.gotBonus ? 'üèÜ' : ''}
                                    ${result?.isWinner && !result?.gotBonus ? 'üèÅ' : ''}
                                    ${result?.attƒ±ƒ∞≈ülerKaƒüƒ±t ? '‚ö†Ô∏è' : ''}
                                    ${result?.jokerEtkisi ? 'üÉè' : ''}
                                    ${result?.cezayƒ±S√∂yleyenA√ßamadƒ± ? 'üíú' : ''}
                                </div>
                            </td>
                        `;
                    }).join('')}
                `;
                
                tbody.appendChild(tr);
            });
        }

        function checkGameOver() {
            const remaining = getRemainingPenalties();
            if (remaining.length === 0) {
                const leader = getLeader();
                const scores = getCurrentScores();
                
                saveGameToHistory();
                
                document.getElementById('roundInputSection').classList.add('hidden');
                document.getElementById('gameOverSection').classList.remove('hidden');
                document.getElementById('gameOverText').textContent = `${t('allPenaltiesPlayed')} ${leader} (${scores[leader]} ${t('points')})`;
            }
        }

        function saveGameToHistory() {
            const finalScores = getCurrentScores();
            const winner = getLeader();
            
            const gameRecord = {
                id: Date.now(),
                date: new Date().toLocaleString(gameState.language === 'tr' ? 'tr-TR' : 'en-US'),
                startDate: gameState.gameStartDate || new Date().toLocaleString(gameState.language === 'tr' ? 'tr-TR' : 'en-US'),
                players: [...gameState.players],
                gameStake: gameState.gameStake,
                totalRounds: gameState.currentRound - 1,
                finalScores: finalScores,
                winner: winner,
                gameHistory: [...gameState.gameHistory],
                customPenaltiesUsed: gameState.customPenalties.filter(cp => 
                    gameState.gameHistory.some(round => round.penaltyId === cp.id)
                ),
                language: gameState.language
            };

            try {
                const savedGames = JSON.parse(localStorage.getItem('americano_game_history') || '[]');
                savedGames.unshift(gameRecord);
                
                if (savedGames.length > 50) {
                    savedGames.splice(50);
                }
                
                localStorage.setItem('americano_game_history', JSON.stringify(savedGames));
            } catch (error) {
                console.error('Error saving game to history:', error);
            }
        }

        function showGameHistory() {
            try {
                const savedGames = JSON.parse(localStorage.getItem('americano_game_history') || '[]');
                const container = document.getElementById('gameHistoryList');
                
                if (savedGames.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-lg">${t('noGameHistory')}</p>
                            <p class="text-sm mt-2">${t('completeFirstGame')}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    savedGames.forEach((game, index) => {
                        const gameDiv = document.createElement('div');
                        gameDiv.className = 'bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border hover:shadow-md transition-all cursor-pointer mb-4';
                        gameDiv.onclick = () => showGameDetail(game);
                        
                        const playersText = game.players.join(', ');
                        const scoresText = game.players.map(p => `${p}: ${game.finalScores[p]}`).join(' | ');
                        
                        gameDiv.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                            ${gameState.language === 'tr' ? 'Oyun' : 'Game'} #${savedGames.length - index}
                                        </span>
                                        <span class="text-gray-500 text-sm">${game.date}</span>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-800 mb-1">
                                        üèÜ ${gameState.language === 'tr' ? 'Kazanan' : 'Winner'}: ${game.winner} (${game.finalScores[game.winner]} ${t('points')})
                                    </h3>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>${gameState.language === 'tr' ? 'Oyuncular' : 'Players'}:</strong> ${playersText}
                                    </p>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>${gameState.language === 'tr' ? 'Oyun' : 'Game'}:</strong> ${game.gameStake || (gameState.language === 'tr' ? 'Belirtilmemi≈ü' : 'Not specified')} | 
                                        <strong>${gameState.language === 'tr' ? 'El Sayƒ±sƒ±' : 'Round Count'}:</strong> ${game.totalRounds}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        ${scoresText}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl">üéÆ</div>
                                    <div class="text-xs text-gray-500 mt-1">${gameState.language === 'tr' ? 'Detaylar i√ßin tƒ±kla' : 'Click for details'}</div>
                                </div>
                            </div>
                        `;
                        container.appendChild(gameDiv);
                    });
                }
                
                document.getElementById('gameHistoryModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading game history:', error);
                alert(gameState.language === 'tr' ? 'Oyun ge√ßmi≈üi y√ºklenirken hata olu≈ütu' : 'Error loading game history');
            }
        }

        function showGameDetail(game) {
            // Game detail implementation would be here
            // This is a simplified version
            alert(gameState.language === 'tr' ? 'Oyun detaylarƒ± yakƒ±nda eklenecek' : 'Game details coming soon');
        }

        function closeGameHistoryModal() {
            document.getElementById('gameHistoryModal').classList.add('hidden');
        }

        function closeGameDetailModal() {
            document.getElementById('gameDetailModal').classList.add('hidden');
        }

        function resetGame() {
            gameState.gameStarted = false;
            gameState.currentRound = 1;
            gameState.selectedPenalty = '';
            gameState.penaltyCaller = '';
            gameState.i≈ülerKaƒüƒ±tAtan = '';
            gameState.jokerIleBitiren = '';
            gameState.cezayƒ±S√∂yleyenA√ßamadƒ± = '';
            
            gameState.roundPenalties = {};
            gameState.players.forEach(player => {
                gameState.roundPenalties[player] = '';
            });
            gameState.roundWinner = '';
            gameState.gameHistory = [];
            gameState.playedPenalties = {};
            
            document.getElementById('roundInputSection').classList.remove('hidden');
            document.getElementById('gameOverSection').classList.add('hidden');
            document.getElementById('gameHistorySection').classList.add('hidden');
            
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
        }

        function showRules() {
            alert(gameState.language === 'tr' ? 'Kurallar modal\'ƒ± yakƒ±nda eklenecek' : 'Rules modal coming soon');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Rules Modal (to be implemented) -->
    <div id="rulesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="max-w-4xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
            <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 id="rulesModalTitle" class="text-2xl font-bold text-gray-800">üìñ Detaylƒ± Americano Kurallarƒ±</h2>
                    <button onclick="closeRules()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                        ‚úï
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-6 text-gray-700">
                    <!-- Rules content would be here -->
                    <p class="text-center text-gray-500">Rules content coming soon...</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
