<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸƒ Americano Oyun Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .hidden { display: none !important; }
        .fade-in { 
            opacity: 0;
            animation: fadeIn 0.3s ease forwards;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        
        /* Mobil iÃ§in Ã¶zel input styling */
        @media (max-width: 768px) {
            /* TÃ¼m grid'leri mobilde tek kolona zorla */
            .grid {
                grid-template-columns: 1fr !important;
            }
            
            input[type="text"], input[type="number"], select {
                font-size: 18px !important;
                padding: 16px !important;
                min-height: 60px !important;
                line-height: 1.2 !important;
                width: 100% !important;
            }
            
            input::placeholder {
                font-size: 16px !important;
            }
            
            /* Mobil Safari iÃ§in zoom engelleyici */
            input[type="text"]:focus,
            input[type="number"]:focus,
            select:focus {
                font-size: 18px !important;
                transform: scale(1);
            }
            
            /* Button'larÄ± da bÃ¼yÃ¼lt */
            button {
                min-height: 48px !important;
                font-size: 14px !important;
                padding: 12px 16px !important;
            }
            
            /* Player cards'Ä±nÄ± daha geniÅŸ yap */
            .grid > div {
                width: 100% !important;
                margin-bottom: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="app" class="max-w-7xl mx-auto p-6 min-h-screen transition-colors bg-gradient-to-br from-purple-50 to-blue-100">
        
        <!-- Setup Screen -->
        <div id="setupScreen" class="max-w-4xl mx-auto">
            <div class="bg-white rounded-2xl shadow-xl p-8">
                <div class="text-center mb-8">
                    <div class="flex items-center justify-center gap-3 mb-4">
                        <div class="w-8 h-8 text-purple-600 flex items-center justify-center">âš™ï¸</div>
                        <h1 class="text-3xl font-bold text-gray-800">ğŸƒ Americano Oyun Kurulumu</h1>
                    </div>
                    <p class="text-gray-600">Oyuncu sayÄ±sÄ± ve isimlerini ayarlayÄ±n</p>
                </div>

                <!-- Player Count Section -->
                <div class="rounded-xl p-6 mb-6 bg-blue-50">
                    <h3 class="font-bold text-lg mb-4 text-center text-gray-800">Oyuncu SayÄ±sÄ±</h3>
                    <div class="flex items-center justify-center gap-4">
                        <button id="removePlayerBtn" class="p-3 rounded-lg font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed">
                            â–
                        </button>
                        <div id="playerCountDisplay" class="text-4xl font-bold text-purple-600 rounded-lg py-3 px-6 shadow-inner min-w-[80px] text-center bg-white">
                            3
                        </div>
                        <button id="addPlayerBtn" class="p-3 rounded-lg font-bold transition-all bg-green-500 text-white hover:bg-green-600">
                            â•
                        </button>
                    </div>
                    <p class="text-center mt-2 text-gray-600">3-5 oyuncu</p>
                </div>

                <!-- Player Names Section -->
                <div class="rounded-xl p-6 mb-6 bg-yellow-50">
                    <h3 class="font-bold text-lg mb-4 text-center text-gray-800">Oyuncu Ä°simleri</h3>
                    <div id="playerInputs" class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                        <!-- Player inputs will be dynamically generated -->
                    </div>
                </div>

                <!-- Game Stake Section -->
                <div class="rounded-xl p-6 mb-6 bg-orange-50">
                    <h3 class="font-bold text-lg mb-4 text-center text-gray-800">Bu Oyun Neye OynanÄ±yor?</h3>
                    <div class="mb-4">
                        <input type="text" id="gameStakeInput" class="w-full p-4 md:p-4 text-lg md:text-xl min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg text-center font-medium"
                               placeholder="Ã–rnek: Kahve Ä±smarlama, Yemek Ä±smarlama..." style="font-size: 18px !important; padding: 16px !important;" />
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                        <button onclick="setStake('Kahve Ä±smarlama')" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">â˜• Kahve</button>
                        <button onclick="setStake('Yemek Ä±smarlama')" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">ğŸ• Yemek</button>
                        <button onclick="setStake('Dondurma Ä±smarlama')" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">ğŸ¦ Dondurma</button>
                        <button onclick="setStake('Sadece eÄŸlence')" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">ğŸ‰ EÄŸlence</button>
                        <button onclick="setStake('ğŸ’° Para')" class="p-2 rounded-lg text-sm bg-white hover:bg-gray-50 text-black transition-colors">ğŸ’° Para</button>
                        <button onclick="setCustomStake()" class="p-2 rounded-lg text-sm bg-blue-100 hover:bg-blue-200 text-blue-800 transition-colors">âœï¸ Ã–zel</button>
                    </div>
                </div>

                <!-- Start Button -->
                <div class="text-center">
                    <button id="startGameBtn" class="px-8 py-4 rounded-lg font-bold text-white text-xl transition-all bg-gray-400 cursor-not-allowed">
                        ğŸ¯ Oyunu BaÅŸlat
                    </button>
                    <div id="startGameError" class="text-red-500 mt-2 text-sm hidden">LÃ¼tfen tÃ¼m oyuncu isimlerini doldurun</div>
                    <div id="gameStakeDisplay" class="mt-3 p-2 bg-orange-100 rounded-lg hidden">
                        <p class="text-orange-800 text-sm">ğŸ† Bu oyun: <strong id="gameStakeText"></strong></p>
                    </div>
                </div>

                <!-- Rules Section -->
                <div class="bg-green-50 rounded-xl p-6 mt-6">
                    <h3 class="font-bold text-lg text-gray-800 mb-3">Oyun KurallarÄ±:</h3>
                    <ul class="space-y-2 text-gray-700">
                        <li>â€¢ <strong>3, 4 veya 5 oyuncuyla</strong> oynanÄ±r</li>
                        <li>â€¢ <strong>13 farklÄ± ceza</strong> tÃ¼rÃ¼ vardÄ±r</li>
                        <li>â€¢ <strong>"Elden" cezasÄ±</strong> mecburen son elde (13. el) oynanÄ±r</li>
                        <li>â€¢ <strong>CezayÄ± sÃ¶yleyen VE bitiren</strong> aynÄ± kiÅŸiyse +50 puan</li>
                        <li>â€¢ <strong>CezayÄ± sÃ¶yleyen baÅŸarÄ±sÄ±z:</strong> GÃ¶revini yapamadan (aÃ§amadan) baÅŸkasÄ± bitirirse x2 ceza puanÄ± alÄ±r</li>
                        <li>â€¢ <strong>Son elde (Elden) bonus yok:</strong> CezayÄ± sÃ¶yleyip bitiren +50 alamaz</li>
                        <li>â€¢ <strong>Ä°ÅŸler kaÄŸÄ±t atan</strong> oyuncu -50 ceza puanÄ± alÄ±r</li>
                        <li>â€¢ <strong>Joker ile bitiren</strong> herkese x2 ceza puanÄ± yedirir</li>
                        <li>â€¢ <strong>Kazanma:</strong> En yÃ¼ksek puan kazanÄ±r (eksi puanlarda en dÃ¼ÅŸÃ¼k eksi puan)</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen" class="hidden rounded-2xl shadow-xl p-8 bg-white">
            
            <!-- Game Header -->
            <div class="text-center mb-8">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <div class="w-8 h-8 text-purple-600 flex items-center justify-center">â–¶ï¸</div>
                    <h1 class="text-3xl font-bold text-gray-800">ğŸƒ Americano</h1>
                    <button onclick="backToSetup()" class="ml-4 p-2 transition-all rounded-lg text-gray-500 hover:text-gray-700" title="Ayarlara dÃ¶n">
                        âš™ï¸
                    </button>
                    <button id="darkModeBtn" onclick="toggleDarkMode()" class="ml-2 p-2 rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300" title="Gece modu">
                        ğŸŒ™
                    </button>
                </div>
                <p id="playersDisplay" class="text-gray-600"></p>
                <div class="mt-2 text-lg font-semibold text-purple-600">
                    El <span id="currentRoundDisplay">1</span> - <span id="remainingPenaltiesDisplay">13</span>/13 ceza kaldÄ±
                </div>
                <div id="gameStakeGameDisplay" class="mt-2 text-sm text-orange-600 hidden">
                    ğŸ† Bu oyun: <strong id="gameStakeGameText"></strong>
                </div>
            </div>

            <!-- Leader Banner -->
            <div id="leaderBanner" class="p-4 rounded-xl mb-6 text-center bg-gradient-to-r from-purple-400 to-blue-500 text-white hidden">
                <div class="flex items-center justify-center gap-2">
                    <div class="w-6 h-6 flex items-center justify-center">ğŸ†</div>
                    <span id="leaderText" class="font-bold text-lg"></span>
                </div>
            </div>

            <!-- Score Cards -->
            <div id="scoreCards" class="grid gap-4 mb-8 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                <!-- Score cards will be dynamically generated -->
            </div>

            <!-- Round Input Section -->
            <div id="roundInputSection" class="bg-blue-50 rounded-xl p-6 mb-6">
                <h3 class="font-bold text-lg text-gray-800 mb-4">El <span id="roundInputTitle">1</span> - Puan GiriÅŸi</h3>
                
                <!-- Penalty and Caller Selection -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Bu Elde Oynanan Ceza:</label>
                        <select id="selectedPenalty" class="w-full p-4 md:p-3 text-lg md:text-lg min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg font-medium" style="font-size: 18px !important; padding: 16px !important;">
                            <option value="">Ceza seÃ§in...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">CezayÄ± SÃ¶yleyen Oyuncu:</label>
                        <select id="penaltyCaller" class="w-full p-4 md:p-3 text-lg md:text-lg min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg font-medium" style="font-size: 18px !important; padding: 16px !important;">
                            <option value="">Oyuncu seÃ§in...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Player Input Cards -->
                <div id="playerInputCards" class="grid gap-4 mb-6 grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
                    <!-- Player input cards will be dynamically generated -->
                </div>
                
                <!-- Calculate Button -->
                <div class="text-center">
                    <div id="warningMessages">
                        <!-- Warning messages will be dynamically added here -->
                    </div>
                    
                    <button id="calculateBtn" onclick="calculateRoundScore()" class="px-8 py-3 rounded-lg font-bold text-white transition-all bg-gray-400 cursor-not-allowed">
                        TÃ¼m AlanlarÄ± Doldurun
                    </button>
                </div>
            </div>

            <!-- Game Over -->
            <div id="gameOverSection" class="bg-gradient-to-r from-green-400 to-blue-500 text-white p-6 rounded-xl mb-6 text-center hidden">
                <h2 class="text-2xl font-bold mb-2">ğŸ‰ OYUN BÄ°TTÄ°! ğŸ‰</h2>
                <p id="gameOverText" class="text-lg"></p>
            </div>

            <!-- Game History Table -->
            <div id="gameHistorySection" class="bg-gray-50 rounded-xl p-6 mb-6 hidden">
                <h3 class="font-bold text-lg text-gray-800 mb-4 flex items-center gap-2">
                    <div class="w-5 h-5 flex items-center justify-center">ğŸ“Š</div>
                    KÃ¼mÃ¼latif Puan Tablosu
                </h3>
                <div class="overflow-x-auto">
                    <table id="gameHistoryTable" class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow">
                        <thead id="gameHistoryTableHead">
                            <!-- Table header will be dynamically generated -->
                        </thead>
                        <tbody id="gameHistoryTableBody">
                            <!-- Table body will be dynamically generated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Remaining Penalties -->
            <div class="bg-yellow-50 rounded-xl p-6 mb-6">
                <h3 class="font-bold text-lg text-gray-800 mb-4 text-center">
                    Kalan Cezalar - <span id="remainingCount">13</span>/13
                </h3>
                <div id="remainingPenalties" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                    <!-- Remaining penalties will be dynamically generated -->
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex gap-4 justify-center flex-wrap">
                <button onclick="showGameHistory()" class="font-bold py-3 px-6 rounded-lg transition-all bg-green-500 hover:bg-green-600 text-white">
                    ğŸ“Š GeÃ§miÅŸ Oyunlar
                </button>
                <button onclick="showRules()" class="font-bold py-3 px-6 rounded-lg transition-all bg-blue-500 hover:bg-blue-600 text-white">
                    ğŸ“– KurallarÄ± Oku
                </button>
                <button onclick="backToSetup()" class="font-bold py-3 px-6 rounded-lg transition-all hover:scale-105 flex items-center gap-2 bg-blue-500 hover:bg-blue-600 text-white">
                    <div class="w-5 h-5 flex items-center justify-center">âš™ï¸</div>
                    Oyuncu AyarlarÄ±
                </button>
                <button onclick="resetGame()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-all hover:scale-105 flex items-center gap-2">
                    <div class="w-5 h-5 flex items-center justify-center">ğŸ”„</div>
                    Yeni Oyun BaÅŸlat
                </button>
            </div>
        </div>

        <!-- Custom Penalty Modal -->
        <div id="customPenaltyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="max-w-md w-full rounded-2xl shadow-2xl bg-white">
                <div class="p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">âš¡ Yeni Ã–zel Ceza</h2>
                        <button onclick="closeCustomPenaltyModal()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            âœ•
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <form id="customPenaltyForm" onsubmit="saveCustomPenalty(event)">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Ceza AdÄ±:</label>
                                <input type="text" id="customPenaltyName" required 
                                       class="w-full p-3 border border-gray-300 rounded-lg font-medium"
                                       placeholder="Ã–rnek: 6'lÄ± Seri" />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">KÄ±sa Ad:</label>
                                <input type="text" id="customPenaltyShort" required maxlength="6"
                                       class="w-full p-3 border border-gray-300 rounded-lg font-medium"
                                       placeholder="Ã–rnek: 6S" />
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Sembol:</label>
                                <input type="text" id="customPenaltySymbol" readonly
                                       class="w-full p-3 border border-gray-300 rounded-lg font-medium bg-gray-100"
                                       placeholder="Otomatik oluÅŸturulacak" />
                            </div>
                            
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <p class="text-sm text-blue-700">
                                    <strong>Not:</strong> EklediÄŸiniz Ã¶zel ceza, normal cezalar gibi oyunda kullanÄ±labilecek.
                                    Sembol otomatik olarak oluÅŸturulacak.
                                </p>
                            </div>
                        </div>
                        
                        <div class="flex gap-3 mt-6">
                            <button type="button" onclick="closeCustomPenaltyModal()" 
                                    class="flex-1 py-3 px-4 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition-all">
                                Ä°ptal
                            </button>
                            <button type="submit" 
                                    class="flex-1 py-3 px-4 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 transition-all">
                                Ceza Ekle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Game History Modal -->
        <div id="gameHistoryModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="max-w-4xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
                <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ“Š GeÃ§miÅŸ Oyunlar</h2>
                        <button onclick="closeGameHistoryModal()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            âœ•
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="gameHistoryList">
                        <!-- Game history will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Game Detail Modal -->
        <div id="gameDetailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="max-w-4xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
                <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ® Oyun DetaylarÄ±</h2>
                        <button onclick="closeGameDetailModal()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                            âœ•
                        </button>
                    </div>
                </div>
                
                <div class="p-6">
                    <div id="gameDetailContent">
                        <!-- Game detail will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game state variables
        let gameState = {
            gameStarted: false,
            playerCount: 3,
            players: ['', '', ''],
            darkMode: false,
            gameStake: '',
            currentRound: 1,
            selectedPenalty: '',
            penaltyCaller: '',
            roundPenalties: {},
            roundWinner: '',
            iÅŸlerKaÄŸÄ±tAtan: '',
            jokerIleBitiren: '',
            cezayÄ±SÃ¶yleyenAÃ§amadÄ±: '',
            gameHistory: [],
            playedPenalties: {},
            customPenalties: [], // KullanÄ±cÄ± tanÄ±mlÄ± cezalar
            gameStartDate: null
        };

        let defaultPenalties = [
            { id: 1, name: "3'lÃ¼ Seri", short: "3S", symbol: "â‘ ", isCustom: false },
            { id: 2, name: "3'lÃ¼ KÃ¼t", short: "3K", symbol: "â‘¡", isCustom: false },
            { id: 3, name: "3'lÃ¼ Seri + 3'lÃ¼ KÃ¼t", short: "3S3K", symbol: "â‘¢", isCustom: false },
            { id: 4, name: "2 3'lÃ¼ Seri", short: "23S", symbol: "â‘£", isCustom: false },
            { id: 5, name: "2 3'lÃ¼ KÃ¼t", short: "23K", symbol: "â‘¤", isCustom: false },
            { id: 6, name: "4'lÃ¼ Seri", short: "4S", symbol: "â‘¥", isCustom: false },
            { id: 7, name: "4'lÃ¼ KÃ¼t", short: "4K", symbol: "â‘¦", isCustom: false },
            { id: 8, name: "4 Seri 4 KÃ¼t", short: "4S4K", symbol: "â‘§", isCustom: false },
            { id: 9, name: "2 4'lÃ¼ Seri", short: "24S", symbol: "â‘¨", isCustom: false },
            { id: 10, name: "2 4'lÃ¼ KÃ¼t", short: "24K", symbol: "â‘©", isCustom: false },
            { id: 11, name: "5'li Seri", short: "5S", symbol: "â‘ª", isCustom: false },
            { id: 12, name: "Ã‡ift", short: "Ã‡", symbol: "â‘«", isCustom: false },
            { id: 13, name: "Elden", short: "E", symbol: "â‘¬", isCustom: false }
        ];

        // Get all penalties (default + custom)
        function getAllPenalties() {
            return [...defaultPenalties, ...gameState.customPenalties];
        }

        // Initialize the app
        function initApp() {
            loadCustomPenalties();
            updatePlayerInputs();
            updatePlayerCount();
            updateStartButton();
            initEventListeners();
            // Custom penalties list will be updated when needed
        }

        function loadCustomPenalties() {
            try {
                const saved = localStorage.getItem('americano_custom_penalties');
                if (saved) {
                    gameState.customPenalties = JSON.parse(saved);
                }
            } catch (error) {
                console.error('Error loading custom penalties:', error);
                gameState.customPenalties = [];
            }
        }

        function saveCustomPenaltiesToStorage() {
            try {
                localStorage.setItem('americano_custom_penalties', JSON.stringify(gameState.customPenalties));
            } catch (error) {
                console.error('Error saving custom penalties:', error);
            }
        }

        function initEventListeners() {
            document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
            document.getElementById('removePlayerBtn').addEventListener('click', removePlayer);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('gameStakeInput').addEventListener('input', updateGameStake);
        }

        function addPlayer() {
            if (gameState.playerCount < 5) {
                gameState.playerCount++;
                gameState.players.push(`Oyuncu ${gameState.playerCount}`);
                updatePlayerInputs();
                updatePlayerCount();
                updateStartButton();
            }
        }

        function removePlayer() {
            if (gameState.playerCount > 3) {
                gameState.playerCount--;
                gameState.players.pop();
                updatePlayerInputs();
                updatePlayerCount();
                updateStartButton();
            }
        }

        function updatePlayerCount() {
            document.getElementById('playerCountDisplay').textContent = gameState.playerCount;
            
            const removeBtn = document.getElementById('removePlayerBtn');
            const addBtn = document.getElementById('addPlayerBtn');
            
            if (gameState.playerCount <= 3) {
                removeBtn.className = 'p-3 rounded-lg font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
            } else {
                removeBtn.className = 'p-3 rounded-lg font-bold transition-all bg-red-500 text-white hover:bg-red-600';
            }
            
            if (gameState.playerCount >= 5) {
                addBtn.className = 'p-3 rounded-lg font-bold transition-all bg-gray-300 text-gray-500 cursor-not-allowed';
            } else {
                addBtn.className = 'p-3 rounded-lg font-bold transition-all bg-green-500 text-white hover:bg-green-600';
            }
        }

        function updatePlayerInputs() {
            const container = document.getElementById('playerInputs');
            const gridClass = gameState.playerCount === 3 ? 'grid-cols-3' : 
                             gameState.playerCount === 4 ? 'grid-cols-2 md:grid-cols-4' : 
                             'grid-cols-2 md:grid-cols-3 lg:grid-cols-5';
            
            container.className = `grid gap-4 ${gridClass}`;
            container.innerHTML = '';
            
            gameState.players.forEach((player, index) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'rounded-lg p-4 bg-white';
                playerDiv.innerHTML = `
                    <label class="block text-sm font-medium mb-2 text-gray-700">Oyuncu ${index + 1}</label>
                    <input type="text" value="${player}" onchange="updatePlayerName(${index}, this.value)"
                           class="w-full p-3 border border-gray-300 rounded-lg text-center font-medium text-lg bg-white text-black placeholder-gray-400"
                           placeholder="Oyuncu ${index + 1}" />
                `;
                container.appendChild(playerDiv);
            });
        }

        function updatePlayerName(index, name) {
            gameState.players[index] = name;
            updateStartButton();
        }

        function updateStartButton() {
            const allFilled = gameState.players.every(player => player.trim() !== '');
            const startBtn = document.getElementById('startGameBtn');
            const errorDiv = document.getElementById('startGameError');
            
            if (allFilled) {
                startBtn.className = 'px-8 py-4 rounded-lg font-bold text-white text-xl transition-all bg-purple-600 hover:bg-purple-700 hover:scale-105';
                errorDiv.classList.add('hidden');
            } else {
                startBtn.className = 'px-8 py-4 rounded-lg font-bold text-white text-xl transition-all bg-gray-400 cursor-not-allowed';
                errorDiv.classList.remove('hidden');
            }
        }

        function setStake(stake) {
            gameState.gameStake = stake;
            document.getElementById('gameStakeInput').value = stake;
            updateGameStakeDisplay();
        }

        function setCustomStake() {
            const custom = prompt('Ã–zel iddia yazÄ±n:');
            if (custom) {
                setStake(custom);
            }
        }

        function updateGameStake() {
            gameState.gameStake = document.getElementById('gameStakeInput').value;
            updateGameStakeDisplay();
        }

        function updateGameStakeDisplay() {
            const display = document.getElementById('gameStakeDisplay');
            const text = document.getElementById('gameStakeText');
            
            if (gameState.gameStake) {
                text.textContent = gameState.gameStake;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function startGame() {
            startGameFromSetup();
        }

        function backToSetup() {
            // Oyunu sÄ±fÄ±rlamadan sadece setup ekranÄ±na dÃ¶n
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
            // gameState.gameStarted = false; // Bu satÄ±rÄ± kaldÄ±rdÄ±k
            // resetGame(); // Bu satÄ±rÄ± kaldÄ±rdÄ±k
        }

        function startGameFromSetup() {
            const allFilled = gameState.players.every(player => player.trim() !== '');
            if (!allFilled) return;
            
            // EÄŸer oyun devam ediyorsa, sadece ekranlarÄ± deÄŸiÅŸtir
            if (gameState.gameStarted) {
                document.getElementById('setupScreen').classList.add('hidden');
                document.getElementById('gameScreen').classList.remove('hidden');
                updateGameScreen();
                return;
            }
            
            // Yeni oyun baÅŸlat
            gameState.gameStarted = true;
            gameState.gameStartDate = new Date().toLocaleString('tr-TR');
            gameState.roundPenalties = {};
            gameState.players.forEach(player => {
                gameState.roundPenalties[player] = '';
            });
            
            document.getElementById('setupScreen').classList.add('hidden');
            document.getElementById('gameScreen').classList.remove('hidden');
            
            updateGameScreen();
        }

        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            const app = document.getElementById('app');
            const gameScreen = document.getElementById('gameScreen');
            const setupScreen = document.getElementById('setupScreen');
            const btn = document.getElementById('darkModeBtn');
            
            if (gameState.darkMode) {
                // Dark mode - tÃ¼m ekranÄ± dark yap
                app.className = 'max-w-7xl mx-auto p-6 min-h-screen transition-colors bg-gray-900';
                if (gameScreen) gameScreen.className = gameScreen.className.replace('bg-white', 'bg-gray-800 text-white');
                if (setupScreen) {
                    const setupCard = setupScreen.querySelector('.bg-white');
                    if (setupCard) setupCard.className = setupCard.className.replace('bg-white', 'bg-gray-800 text-white');
                }
                btn.textContent = 'â˜€ï¸';
                btn.title = 'GÃ¼ndÃ¼z modu';
                btn.className = 'ml-2 p-2 rounded-lg transition-all bg-yellow-500 text-gray-900 hover:bg-yellow-400';
            } else {
                // Light mode
                app.className = 'max-w-7xl mx-auto p-6 min-h-screen transition-colors bg-gradient-to-br from-purple-50 to-blue-100';
                if (gameScreen) gameScreen.className = gameScreen.className.replace('bg-gray-800 text-white', 'bg-white');
                if (setupScreen) {
                    const setupCard = setupScreen.querySelector('.bg-gray-800');
                    if (setupCard) setupCard.className = setupCard.className.replace('bg-gray-800 text-white', 'bg-white');
                }
                btn.textContent = 'ğŸŒ™';
                btn.title = 'Gece modu';
                btn.className = 'ml-2 p-2 rounded-lg transition-all bg-gray-200 text-gray-700 hover:bg-gray-300';
            }
        }

        function updateGameScreen() {
            document.getElementById('playersDisplay').textContent = gameState.players.join(' - ');
            document.getElementById('currentRoundDisplay').textContent = gameState.currentRound;
            document.getElementById('roundInputTitle').textContent = gameState.currentRound;
            
            updateRemainingPenalties();
            updateScoreCards();
            updatePenaltySelector();
            updatePlayerSelector();
            updatePlayerInputCards();
            updateGameStakeGameDisplay();
        }

        function updateGameStakeGameDisplay() {
            const display = document.getElementById('gameStakeGameDisplay');
            const text = document.getElementById('gameStakeGameText');
            
            if (gameState.gameStake) {
                text.textContent = gameState.gameStake;
                display.classList.remove('hidden');
            } else {
                display.classList.add('hidden');
            }
        }

        function getRemainingPenalties() {
            return penalties.filter(p => !gameState.playedPenalties[p.id]);
        }

        function getAvailablePenalties() {
            const available = getRemainingPenalties();
            if (available.length > 1 && available.some(p => p.id === 13)) {
                return available.filter(penalty => penalty.id !== 13);
            }
            return available;
        }

        // Game History Functions
        function saveGameToHistory() {
            const finalScores = getCurrentScores();
            const winner = getLeader();
            
            const gameRecord = {
                id: Date.now(),
                date: new Date().toLocaleString('tr-TR'),
                startDate: gameState.gameStartDate || new Date().toLocaleString('tr-TR'),
                players: [...gameState.players],
                gameStake: gameState.gameStake,
                totalRounds: gameState.currentRound - 1,
                finalScores: finalScores,
                winner: winner,
                gameHistory: [...gameState.gameHistory],
                customPenaltiesUsed: gameState.customPenalties.filter(cp => 
                    gameState.gameHistory.some(round => round.penaltyId === cp.id)
                )
            };

            try {
                const savedGames = JSON.parse(localStorage.getItem('americano_game_history') || '[]');
                savedGames.unshift(gameRecord); // Add to beginning
                
                // Keep only last 50 games
                if (savedGames.length > 50) {
                    savedGames.splice(50);
                }
                
                localStorage.setItem('americano_game_history', JSON.stringify(savedGames));
                console.log('Game saved to history:', gameRecord);
            } catch (error) {
                console.error('Error saving game to history:', error);
            }
        }

        function showGameHistory() {
            try {
                const savedGames = JSON.parse(localStorage.getItem('americano_game_history') || '[]');
                const container = document.getElementById('gameHistoryList');
                
                if (savedGames.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8 text-gray-500">
                            <p class="text-lg">HenÃ¼z oyun geÃ§miÅŸi yok</p>
                            <p class="text-sm mt-2">Ä°lk oyununuzu tamamlayÄ±n ve burada gÃ¶rÃ¼n</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = '';
                    savedGames.forEach((game, index) => {
                        const gameDiv = document.createElement('div');
                        gameDiv.className = 'bg-gradient-to-r from-blue-50 to-green-50 p-4 rounded-lg border hover:shadow-md transition-all cursor-pointer mb-4';
                        gameDiv.onclick = () => showGameDetail(game);
                        
                        const playersText = game.players.join(', ');
                        const scoresText = game.players.map(p => `${p}: ${game.finalScores[p]}`).join(' | ');
                        
                        gameDiv.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-2 mb-2">
                                        <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-medium">
                                            Oyun #${savedGames.length - index}
                                        </span>
                                        <span class="text-gray-500 text-sm">${game.date}</span>
                                    </div>
                                    <h3 class="font-bold text-lg text-gray-800 mb-1">
                                        ğŸ† Kazanan: ${game.winner} (${game.finalScores[game.winner]} puan)
                                    </h3>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>Oyuncular:</strong> ${playersText}
                                    </p>
                                    <p class="text-sm text-gray-600 mb-2">
                                        <strong>Oyun:</strong> ${game.gameStake || 'BelirtilmemiÅŸ'} | 
                                        <strong>El SayÄ±sÄ±:</strong> ${game.totalRounds}
                                    </p>
                                    <p class="text-xs text-gray-500">
                                        ${scoresText}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-2xl">ğŸ®</div>
                                    <div class="text-xs text-gray-500 mt-1">Detaylar iÃ§in tÄ±kla</div>
                                </div>
                            </div>
                        `;
                        container.appendChild(gameDiv);
                    });
                }
                
                document.getElementById('gameHistoryModal').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading game history:', error);
                alert('Oyun geÃ§miÅŸi yÃ¼klenirken hata oluÅŸtu');
            }
        }

        function showGameDetail(game) {
            const container = document.getElementById('gameDetailContent');
            
            const playersScoreCards = game.players.map(player => {
                const score = game.finalScores[player];
                const isWinner = player === game.winner;
                return `
                    <div class="bg-gradient-to-br ${isWinner ? 'from-green-100 to-green-200 border-green-300' : 'from-gray-50 to-gray-100 border-gray-200'} p-4 rounded-lg border-2">
                        <h3 class="font-bold text-lg ${isWinner ? 'text-green-800' : 'text-gray-800'}">${player} ${isWinner ? 'ğŸ‘‘' : ''}</h3>
                        <div class="text-2xl font-bold ${score >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${score > 0 ? '+' : ''}${score}
                        </div>
                        <div class="text-sm text-gray-500">${isWinner ? 'Kazanan!' : 'puan'}</div>
                    </div>
                `;
            }).join('');

            const roundsTable = game.gameHistory.map((round, index) => `
                <tr class="${index % 2 === 0 ? 'bg-gray-50' : 'bg-white'}">
                    <td class="border p-2 text-center font-bold text-purple-600">${round.round}</td>
                    <td class="border p-2 text-center">
                        <div class="font-bold">${round.penaltySymbol}</div>
                        <div class="text-xs">${round.penaltyName}</div>
                    </td>
                    <td class="border p-2 text-center text-blue-600">${round.penaltyCaller}</td>
                    <td class="border p-2 text-center text-green-600">${round.winner}</td>
                    <td class="border p-2 text-center text-xs">
                        ${round.jokerIleBitiren ? 'ğŸƒ ' + round.jokerIleBitiren : ''}
                        ${round.iÅŸlerKaÄŸÄ±tAtan ? 'âš ï¸ ' + round.iÅŸlerKaÄŸÄ±tAtan : ''}
                    </td>
                </tr>
            `).join('');

            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Game Info -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="font-bold text-lg text-blue-800 mb-2">Oyun Bilgileri</h3>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><strong>Tarih:</strong> ${game.date}</div>
                            <div><strong>Oyun:</strong> ${game.gameStake || 'BelirtilmemiÅŸ'}</div>
                            <div><strong>El SayÄ±sÄ±:</strong> ${game.totalRounds}</div>
                            <div><strong>Oyuncu SayÄ±sÄ±:</strong> ${game.players.length}</div>
                        </div>
                    </div>

                    <!-- Final Scores -->
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 mb-4">Final SkorlarÄ±</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${playersScoreCards}
                        </div>
                    </div>

                    <!-- Round by Round -->
                    <div>
                        <h3 class="font-bold text-lg text-gray-800 mb-4">El El Detaylar</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full border-collapse bg-white rounded-lg overflow-hidden shadow">
                                <thead class="bg-purple-600 text-white">
                                    <tr>
                                        <th class="border p-2">El</th>
                                        <th class="border p-2">Ceza</th>
                                        <th class="border p-2">SÃ¶yleyen</th>
                                        <th class="border p-2">Bitiren</th>
                                        <th class="border p-2">Ã–zel</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${roundsTable}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Custom Penalties Used -->
                    ${game.customPenaltiesUsed?.length > 0 ? `
                        <div>
                            <h3 class="font-bold text-lg text-gray-800 mb-4">KullanÄ±lan Ã–zel Cezalar</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                ${game.customPenaltiesUsed.map(cp => `
                                    <div class="bg-purple-50 p-3 rounded-lg border border-purple-200">
                                        <div class="flex items-center gap-2">
                                            <span class="bg-purple-100 text-purple-800 font-bold rounded-full w-6 h-6 flex items-center justify-center text-sm">
                                                ${cp.symbol}
                                            </span>
                                            <div>
                                                <div class="font-medium text-gray-800">${cp.name}</div>
                                                <div class="text-xs text-gray-500">(${cp.short})</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('gameDetailModal').classList.remove('hidden');
        }

        function closeGameHistoryModal() {
            document.getElementById('gameHistoryModal').classList.add('hidden');
        }

        function updateRemainingPenalties() {
            const remaining = getRemainingPenalties();
            document.getElementById('remainingPenaltiesDisplay').textContent = remaining.length;
            document.getElementById('remainingCount').textContent = remaining.length;
            
            const container = document.getElementById('remainingPenalties');
            container.innerHTML = '';
            
            const available = getAvailablePenalties();
            
            if (available.length > 0) {
                available.forEach(penalty => {
                    const div = document.createElement('div');
                    div.className = `bg-white p-3 rounded-lg border-2 transition-all ${penalty.isCustom ? 'border-purple-200 hover:border-purple-400' : 'border-yellow-200 hover:border-yellow-400'}`;
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="${penalty.isCustom ? 'bg-purple-100 text-purple-800' : 'bg-yellow-100 text-yellow-800'} font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">
                                ${penalty.symbol}
                            </span>
                            <div>
                                <div class="font-medium text-gray-800">${penalty.name} ${penalty.isCustom ? 'âš¡' : ''}</div>
                                <div class="text-xs text-gray-500">(${penalty.short})</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(div);
                });
                
                if (!gameState.playedPenalties[13] && available.length > 0) {
                    const eldenDiv = document.createElement('div');
                    eldenDiv.className = 'bg-red-50 p-3 rounded-lg border-2 border-red-200';
                    eldenDiv.innerHTML = `
                        <div class="flex items-center gap-3">
                            <span class="bg-red-100 text-red-800 font-bold rounded-full w-8 h-8 flex items-center justify-center text-sm">â‘¬</span>
                            <div>
                                <div class="font-medium text-red-700">Elden</div>
                                <div class="text-xs text-red-500">(E) - Son elde mecburi</div>
                            </div>
                        </div>
                    `;
                    container.appendChild(eldenDiv);
                }
            } else {
                const message = document.createElement('div');
                message.className = 'text-center text-gray-500 py-4';
                message.innerHTML = `<p class="text-lg">${remaining.length === 1 ? 'Son el - Sadece "Elden" kaldÄ±! ğŸ¯' : 'TÃ¼m cezalar oynandÄ±! ğŸ‰'}</p>`;
                container.appendChild(message);
            }
        }

        function getCurrentScores() {
            const scores = {};
            gameState.players.forEach(player => {
                scores[player] = 0;
            });
            
            gameState.gameHistory.forEach(round => {
                round.results.forEach(result => {
                    scores[result.player] += result.totalChange;
                });
            });
            
            return scores;
        }

        function getLeader() {
            const scores = getCurrentScores();
            const maxScore = Math.max(...Object.values(scores));
            if (maxScore <= 0) return null;
            return Object.keys(scores).find(player => scores[player] === maxScore);
        }

        function updateScoreCards() {
            const scores = getCurrentScores();
            const leader = getLeader();
            const container = document.getElementById('scoreCards');
            // Mobilde tek kolon, bÃ¼yÃ¼k ekranlarda dinamik
            const gridClass = 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3';
            
            container.className = `grid gap-4 mb-8 ${gridClass}`;
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const score = scores[player] || 0;
                const scoreClass = score >= 0 ? 'text-green-600 bg-green-50' : 'text-red-600 bg-red-50';
                
                const div = document.createElement('div');
                div.className = 'rounded-xl p-6 border text-center bg-gradient-to-br from-gray-50 to-gray-100 border-gray-200 w-full';
                div.innerHTML = `
                    <h3 class="font-bold text-lg mb-2 text-gray-800">${player}</h3>
                    <div class="text-3xl font-bold rounded-lg py-3 px-4 shadow-inner ${scoreClass}">
                        ${score > 0 ? '+' : ''}${score}
                    </div>
                    <div class="text-sm mt-1 text-gray-500">toplam puan</div>
                `;
                container.appendChild(div);
            });
            
            // Update leader banner
            const leaderBanner = document.getElementById('leaderBanner');
            const leaderText = document.getElementById('leaderText');
            
            if (leader) {
                leaderText.textContent = `Lider: ${leader} (${scores[leader]} puan)`;
                leaderBanner.classList.remove('hidden');
            } else {
                leaderBanner.classList.add('hidden');
            }
        }

        function updatePenaltySelector() {
            const select = document.getElementById('selectedPenalty');
            const remaining = getRemainingPenalties();
            const available = getAvailablePenalties();
            
            select.innerHTML = '<option value="">Ceza seÃ§in...</option>';
            
            if (remaining.length === 1 && remaining[0].id === 13) {
                select.innerHTML = '';
                const option = document.createElement('option');
                option.value = '13';
                option.textContent = 'â‘¬ Elden (Son El - Mecburi)';
                option.selected = true;
                select.appendChild(option);
                select.style.backgroundColor = '#fef2f2';
                select.style.color = '#b91c1c';
                gameState.selectedPenalty = '13';
            } else {
                available.forEach(penalty => {
                    const option = document.createElement('option');
                    option.value = penalty.id;
                    option.textContent = `${penalty.symbol} ${penalty.name} (${penalty.short})`;
                    select.appendChild(option);
                });
                select.style.backgroundColor = '';
                select.style.color = '';
            }
            
            // Mobil iÃ§in style ekle
            select.style.fontSize = '18px';
            select.style.padding = '16px';
            
            select.addEventListener('change', function() {
                gameState.selectedPenalty = this.value;
                updateCalculateButton();
            });
        }

        function updatePlayerSelector() {
            const select = document.getElementById('penaltyCaller');
            select.className = 'w-full p-4 md:p-3 text-lg md:text-lg min-h-[60px] md:min-h-[50px] border border-gray-300 rounded-lg font-medium';
            select.style.fontSize = '18px';
            select.style.padding = '16px';
            select.innerHTML = '<option value="">Oyuncu seÃ§in...</option>';
            
            gameState.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player;
                option.textContent = player;
                select.appendChild(option);
            });
            
            select.addEventListener('change', function() {
                gameState.penaltyCaller = this.value;
                updatePlayerInputCards();
                updateCalculateButton();
            });
        }

        function updatePlayerInputCards() {
            const container = document.getElementById('playerInputCards');
            const gridClass = gameState.playerCount === 3 ? 'grid-cols-3' : 
                             gameState.playerCount === 4 ? 'grid-cols-2 md:grid-cols-4' : 
                             'grid-cols-2 md:grid-cols-3 lg:grid-cols-5';
            
            container.className = `grid gap-4 mb-6 ${gridClass}`;
            container.innerHTML = '';
            
            gameState.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-lg p-4';
                
                const isWinner = gameState.roundWinner === player;
                const penaltyInput = isWinner ? 
                    `<div class="w-full p-4 border border-gray-200 rounded-xl text-center font-bold text-2xl bg-green-50 text-green-600 h-16 flex items-center justify-center">
                        0 (Eli Bitirdi)
                     </div>` :
                    `<input type="number" min="0" max="13" value="${gameState.roundPenalties[player] || ''}" 
                            onchange="updatePlayerPenalty('${player}', this.value)"
                            class="w-full p-4 border border-gray-300 rounded-xl text-center font-bold text-2xl h-16" placeholder="0" />
                     <div class="text-sm text-gray-500 mt-2 text-center font-medium">
                        <span id="penalty-preview-${player}">-${gameState.roundPenalties[player] || 0} puan</span>
                     </div>`;
                
                div.innerHTML = `
                    <h4 class="font-semibold text-center mb-3">${player}</h4>
                    
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bu Elde Ceza SayÄ±sÄ±</label>
                        ${penaltyInput}
                    </div>
                    
                    <button onclick="toggleRoundWinner('${player}')" 
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all mb-2 ${isWinner ? 'bg-green-500 text-white shadow-lg' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}">
                        ${isWinner ? 'âœ“ Eli Bitirdi' : 'Eli Bitirdi'}
                    </button>
                    
                    <button onclick="toggleJokerWinner('${player}')" 
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all mb-2 ${gameState.jokerIleBitiren === player ? 'bg-orange-500 text-white shadow-lg' : 'bg-orange-100 text-orange-700 hover:bg-orange-200'}">
                        ${gameState.jokerIleBitiren === player ? 'âœ“ Joker Ä°le Bitirdi' : 'Joker Ä°le Bitirdi'}
                    </button>
                    
                    <button onclick="toggleIslerKagit('${player}')" 
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all mb-2 ${gameState.iÅŸlerKaÄŸÄ±tAtan === player ? 'bg-red-500 text-white shadow-lg' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                        ${gameState.iÅŸlerKaÄŸÄ±tAtan === player ? 'âœ“ Ä°ÅŸler KaÄŸÄ±t AttÄ±' : 'Ä°ÅŸler KaÄŸÄ±t AttÄ±'}
                    </button>
                    
                    <button onclick="toggleFailedCaller('${player}')" 
                            ${gameState.penaltyCaller !== player ? 'disabled' : ''}
                            class="w-full py-2 px-3 rounded-lg font-medium transition-all ${gameState.penaltyCaller !== player 
                                ? 'bg-gray-200 text-gray-400 cursor-not-allowed'
                                : gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± === player
                                ? 'bg-purple-500 text-white shadow-lg'
                                : 'bg-purple-100 text-purple-700 hover:bg-purple-200'}">
                        ${gameState.penaltyCaller !== player 
                            ? 'Sadece Ceza SÃ¶yleyen Ä°Ã§in'
                            : gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± === player ? 'âœ“ GÃ¶revini AÃ§amadÄ±' : 'GÃ¶revini AÃ§amadÄ±'
                        }
                    </button>
                    
                    <div id="status-${player}" class="text-center text-xs font-medium mt-1">
                        ${getPlayerStatus(player)}
                    </div>
                `;
                
                container.appendChild(div);
            });
            
            updatePenaltyPreviews();
        }

        function getPlayerStatus(player) {
            const isWinner = gameState.roundWinner === player;
            const isCaller = gameState.penaltyCaller === player;
            const isJoker = gameState.jokerIleBitiren === player;
            const isIsler = gameState.iÅŸlerKaÄŸÄ±tAtan === player;
            const isFailed = gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± === player;
            
            let status = [];
            
            if (isWinner && isCaller && gameState.selectedPenalty !== '13') {
                status.push('<div class="text-green-600">+50 bonus puan (SÃ¶yledi ve Bitirdi)</div>');
            } else if (isWinner && isCaller && gameState.selectedPenalty === '13') {
                status.push('<div class="text-gray-500">Son elde bonus yok (Elden kuralÄ±)</div>');
            }
            
            if (isJoker) {
                status.push('<div class="text-orange-600">ğŸƒ Joker etkisi: Herkese x2 ceza puanÄ±</div>');
            }
            
            if (isIsler) {
                status.push('<div class="text-red-600">-50 ceza puanÄ± (Ä°ÅŸler kaÄŸÄ±t)</div>');
            }
            
            if (isFailed) {
                status.push('<div class="text-purple-600">x2 ceza puanÄ± (GÃ¶revini aÃ§amadÄ±)</div>');
            }
            
            return status.join('');
        }

        function updatePlayerPenalty(player, value) {
            gameState.roundPenalties[player] = value;
            updatePenaltyPreviews();
            updateCalculateButton();
        }

        function updatePenaltyPreviews() {
            gameState.players.forEach(player => {
                const preview = document.getElementById(`penalty-preview-${player}`);
                if (preview) {
                    const baseValue = parseInt(gameState.roundPenalties[player]) || 0;
                    let multiplier = 1;
                    let effects = [];
                    
                    if (gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± === player && gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± !== '') {
                        multiplier *= 2;
                        effects.push('x2 GÃ¶revini aÃ§amadÄ±');
                    }
                    
                    if (gameState.jokerIleBitiren && gameState.jokerIleBitiren !== '') {
                        multiplier *= 2;
                        effects.push('x2 Joker etkisi');
                    }
                    
                    const finalValue = baseValue * multiplier;
                    
                    if (effects.length > 0) {
                        preview.innerHTML = `<span class="text-red-600 font-bold">-${finalValue} puan (${effects.join(' + ')})</span>`;
                    } else {
                        preview.textContent = `-${baseValue} puan`;
                    }
                }
            });
        }

        function toggleRoundWinner(player) {
            gameState.roundWinner = gameState.roundWinner === player ? '' : player;
            updatePlayerInputCards();
            updateCalculateButton();
        }

        function toggleJokerWinner(player) {
            gameState.jokerIleBitiren = gameState.jokerIleBitiren === player ? '' : player;
            if (gameState.jokerIleBitiren === player) {
                gameState.roundWinner = player;
            }
            updatePlayerInputCards();
            updateCalculateButton();
        }

        function toggleIslerKagit(player) {
            gameState.iÅŸlerKaÄŸÄ±tAtan = gameState.iÅŸlerKaÄŸÄ±tAtan === player ? '' : player;
            updatePlayerInputCards();
        }

        function toggleFailedCaller(player) {
            gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± = gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± === player ? '' : player;
            updatePlayerInputCards();
            updatePenaltyPreviews();
        }

        function canCalculate() {
            const allPenaltiesFilled = gameState.players.every(player => 
                player === gameState.roundWinner ? true : gameState.roundPenalties[player] !== undefined && gameState.roundPenalties[player] !== ''
            );
            return gameState.selectedPenalty !== '' && gameState.penaltyCaller !== '' && gameState.roundWinner !== '' && allPenaltiesFilled;
        }

        function updateCalculateButton() {
            const btn = document.getElementById('calculateBtn');
            const canCalc = canCalculate();
            
            if (canCalc) {
                btn.className = 'px-8 py-3 rounded-lg font-bold text-white transition-all bg-purple-600 hover:bg-purple-700 hover:scale-105';
                btn.textContent = 'Eli Kaydet ve Sonrakine GeÃ§';
            } else {
                btn.className = 'px-8 py-3 rounded-lg font-bold text-white transition-all bg-gray-400 cursor-not-allowed';
                btn.textContent = 'TÃ¼m AlanlarÄ± Doldurun';
            }
            
            updateWarningMessages();
        }

        function updateWarningMessages() {
            const container = document.getElementById('warningMessages');
            container.innerHTML = '';
            
            if (gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ±) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-purple-100 rounded-lg border border-purple-300';
                div.innerHTML = `
                    <p class="text-purple-800 font-medium">ğŸ’œ CezayÄ± SÃ¶yleyen GÃ¶revini AÃ§amadÄ±!</p>
                    <p class="text-sm text-purple-700 mt-1">${gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ±} cezayÄ± sÃ¶yledi ama gÃ¶revini aÃ§amadÄ± - x2 ceza puanÄ± alacak</p>
                `;
                container.appendChild(div);
            }
            
            if (gameState.selectedPenalty === '13') {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-blue-100 rounded-lg border border-blue-300';
                div.innerHTML = `
                    <p class="text-blue-800 font-medium">âš ï¸ Son El (Elden) KuralÄ±</p>
                    <p class="text-sm text-blue-700 mt-1">Bu elde cezayÄ± sÃ¶yleyip bitiren oyuncu +50 bonus alamaz</p>
                `;
                container.appendChild(div);
            }
            
            if (gameState.jokerIleBitiren) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-orange-100 rounded-lg border border-orange-300';
                div.innerHTML = `
                    <p class="text-orange-800 font-medium">ğŸƒ Joker Etkisi Aktif!</p>
                    <p class="text-sm text-orange-700 mt-1">${gameState.jokerIleBitiren} joker ile bitirdi - TÃ¼m ceza puanlarÄ± x2 olacak</p>
                `;
                container.appendChild(div);
            }
            
            if (!canCalculate()) {
                const div = document.createElement('div');
                div.className = 'mb-4 p-3 bg-yellow-100 rounded-lg border border-yellow-300';
                const missing = [];
                
                if (!gameState.selectedPenalty) missing.push('â€¢ Oynanan cezayÄ± seÃ§in');
                if (!gameState.penaltyCaller) missing.push('â€¢ CezayÄ± sÃ¶yleyen oyuncuyu seÃ§in');
                if (!gameState.roundWinner) missing.push('â€¢ Eli bitiren oyuncuyu seÃ§in');
                
                const allPenaltiesFilled = gameState.players.every(player => 
                    player === gameState.roundWinner ? true : gameState.roundPenalties[player] !== undefined && gameState.roundPenalties[player] !== ''
                );
                if (!allPenaltiesFilled) missing.push('â€¢ DiÄŸer oyuncularÄ±n ceza sayÄ±sÄ±nÄ± girin');
                
                div.innerHTML = `
                    <p class="text-yellow-800 font-medium">Eksik alanlar:</p>
                    <ul class="text-sm text-yellow-700 mt-2">
                        ${missing.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                `;
                container.appendChild(div);
            }
        }

        function calculateRoundScore() {
            if (!canCalculate()) return;
            
            const scores = getCurrentScores();
            const roundResults = [];
            const allPenalties = getAllPenalties();
            const penalty = allPenalties.find(p => p.id === parseInt(gameState.selectedPenalty));

            gameState.players.forEach(player => {
                let originalPenalty = parseInt(gameState.roundPenalties[player]) || 0;
                let penaltyCount = originalPenalty;
                
                // CezayÄ± sÃ¶yleyen kiÅŸi gÃ¶revini aÃ§amadan baÅŸkasÄ± bitirirse x2 ceza alÄ±r
                if (player === gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± && gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± !== '') {
                    penaltyCount = originalPenalty * 2;
                }
                
                // Joker ile bitiren varsa tÃ¼m oyuncularÄ±n ceza puanlarÄ± 2 katÄ±na Ã§Ä±kar (joker atan da dahil)
                if (gameState.jokerIleBitiren && gameState.jokerIleBitiren !== '') {
                    // EÄŸer hem cezayÄ± sÃ¶yleyen aÃ§amadÄ± hem joker etkisi varsa, Ã¶nce cezayÄ± sÃ¶yleyen x2, sonra joker x2
                    if (player === gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± && gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± !== '') {
                        penaltyCount = originalPenalty * 2 * 2; // 4 katÄ±
                    } else {
                        penaltyCount = originalPenalty * 2;
                    }
                }
                
                // Eli bitiren oyuncunun ceza puanÄ± 0 olur (joker ile bitiren de dahil)
                if (player === gameState.roundWinner) {
                    penaltyCount = 0;
                    originalPenalty = 0;
                }
                
                // Bonus hesaplama - SON ELDE (Elden cezasÄ±) bonus yok!
                let bonusPoints = 0;
                const isLastRound = gameState.selectedPenalty === '13'; // Elden cezasÄ±
                if (player === gameState.roundWinner && player === gameState.penaltyCaller && !isLastRound) {
                    bonusPoints = 50;
                }
                
                const iÅŸlerKaÄŸÄ±tCezasÄ± = player === gameState.iÅŸlerKaÄŸÄ±tAtan ? -50 : 0;
                const totalChange = -penaltyCount + bonusPoints + iÅŸlerKaÄŸÄ±tCezasÄ±;
                
                roundResults.push({
                    player,
                    penalties: penaltyCount,
                    originalPenalties: originalPenalty,
                    bonus: bonusPoints,
                    iÅŸlerKaÄŸÄ±tCezasÄ±: iÅŸlerKaÄŸÄ±tCezasÄ±,
                    totalChange: totalChange,
                    newTotal: scores[player] + totalChange,
                    isWinner: player === gameState.roundWinner,
                    gotBonus: bonusPoints > 0,
                    attÄ±Ä°ÅŸlerKaÄŸÄ±t: player === gameState.iÅŸlerKaÄŸÄ±tAtan,
                    jokerEtkisi: gameState.jokerIleBitiren && gameState.jokerIleBitiren !== '',
                    cezayÄ±SÃ¶yleyenAÃ§amadÄ±: player === gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± && gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± !== ''
                });
            });

            gameState.gameHistory.push({
                round: gameState.currentRound,
                penaltyId: penalty.id,
                penaltyName: penalty.name,
                penaltyShort: penalty.short,
                penaltySymbol: penalty.symbol,
                penaltyCaller: gameState.penaltyCaller,
                iÅŸlerKaÄŸÄ±tAtan: gameState.iÅŸlerKaÄŸÄ±tAtan,
                jokerIleBitiren: gameState.jokerIleBitiren,
                cezayÄ±SÃ¶yleyenAÃ§amadÄ±: gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ±,
                results: roundResults,
                winner: gameState.roundWinner,
                time: new Date().toLocaleTimeString('tr-TR')
            });

            gameState.playedPenalties[penalty.id] = true;

            // Reset for next round
            gameState.selectedPenalty = '';
            gameState.penaltyCaller = '';
            gameState.iÅŸlerKaÄŸÄ±tAtan = '';
            gameState.jokerIleBitiren = '';
            gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± = '';
            
            gameState.roundPenalties = {};
            gameState.players.forEach(player => {
                gameState.roundPenalties[player] = '';
            });
            gameState.roundWinner = '';
            gameState.currentRound++;
            
            updateGameScreen();
            updateGameHistory();
            checkGameOver();
        }

        function updateGameHistory() {
            if (gameState.gameHistory.length === 0) return;
            
            const section = document.getElementById('gameHistorySection');
            section.classList.remove('hidden');
            
            const thead = document.getElementById('gameHistoryTableHead');
            const tbody = document.getElementById('gameHistoryTableBody');
            
            // Create header
            thead.innerHTML = `
                <tr class="bg-purple-600 text-white">
                    <th class="border p-3 font-bold">El</th>
                    <th class="border p-3 font-bold">Ceza / SÃ¶yleyen</th>
                    ${gameState.players.map(player => `<th class="border p-3 font-bold">${player}</th>`).join('')}
                </tr>
            `;
            
            // Create body
            tbody.innerHTML = '';
            gameState.gameHistory.forEach((round, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                
                tr.innerHTML = `
                    <td class="border p-3 text-center">
                        <div class="font-bold text-lg text-purple-600">${round.round}</div>
                        <div class="text-xs text-gray-500">El</div>
                    </td>
                    <td class="border p-3 font-medium text-center">
                        <div class="font-bold">${round.penaltySymbol}</div>
                        <div class="text-xs text-gray-600">${round.penaltyName}</div>
                        <div class="text-xs text-blue-600 font-medium mt-1">ğŸ‘¤ ${round.penaltyCaller}</div>
                        ${round.iÅŸlerKaÄŸÄ±tAtan ? `<div class="text-xs text-red-600 font-medium">âš ï¸ ${round.iÅŸlerKaÄŸÄ±tAtan}</div>` : ''}
                        ${round.jokerIleBitiren ? `<div class="text-xs text-orange-600 font-medium">ğŸƒ ${round.jokerIleBitiren}</div>` : ''}
                        ${round.cezayÄ±SÃ¶yleyenAÃ§amadÄ± ? `<div class="text-xs text-purple-600 font-medium">ğŸ’œ ${round.cezayÄ±SÃ¶yleyenAÃ§amadÄ±}</div>` : ''}
                    </td>
                    ${gameState.players.map(player => {
                        const result = round.results.find(r => r.player === player);
                        return `
                            <td class="border p-3 text-center">
                                <div class="font-bold text-lg ${result?.newTotal >= 0 ? 'text-green-600' : 'text-red-600'}">
                                    ${result?.newTotal || 0}
                                </div>
                                <div class="text-xs text-gray-500">
                                    (${result?.totalChange > 0 ? '+' : ''}${result?.totalChange || 0})
                                    ${result?.gotBonus ? 'ğŸ†' : ''}
                                    ${result?.isWinner && !result?.gotBonus ? 'ğŸ' : ''}
                                    ${result?.attÄ±Ä°ÅŸlerKaÄŸÄ±t ? 'âš ï¸' : ''}
                                    ${result?.jokerEtkisi ? 'ğŸƒ' : ''}
                                    ${result?.cezayÄ±SÃ¶yleyenAÃ§amadÄ± ? 'ğŸ’œ' : ''}
                                </div>
                            </td>
                        `;
                    }).join('')}
                `;
                
                tbody.appendChild(tr);
            });
        }

        function checkGameOver() {
            const remaining = getRemainingPenalties();
            if (remaining.length === 0) {
                const leader = getLeader();
                const scores = getCurrentScores();
                
                // Save game to history
                saveGameToHistory();
                
                document.getElementById('roundInputSection').classList.add('hidden');
                document.getElementById('gameOverSection').classList.remove('hidden');
                document.getElementById('gameOverText').textContent = `TÃ¼m cezalar oynandÄ±. Kazanan: ${leader} (${scores[leader]} puan)`;
            }
        }

        function resetGame() {
            // GerÃ§ekten yeni oyun baÅŸlatmak iÃ§in
            gameState.gameStarted = false;
            gameState.currentRound = 1;
            gameState.selectedPenalty = '';
            gameState.penaltyCaller = '';
            gameState.iÅŸlerKaÄŸÄ±tAtan = '';
            gameState.jokerIleBitiren = '';
            gameState.cezayÄ±SÃ¶yleyenAÃ§amadÄ± = '';
            
            gameState.roundPenalties = {};
            gameState.players.forEach(player => {
                gameState.roundPenalties[player] = '';
            });
            gameState.roundWinner = '';
            gameState.gameHistory = [];
            gameState.playedPenalties = {};
            
            document.getElementById('roundInputSection').classList.remove('hidden');
            document.getElementById('gameOverSection').classList.add('hidden');
            document.getElementById('gameHistorySection').classList.add('hidden');
            
            // Setup ekranÄ±na dÃ¶n
            document.getElementById('setupScreen').classList.remove('hidden');
            document.getElementById('gameScreen').classList.add('hidden');
        }

        function showRules() {
            document.getElementById('rulesModal').classList.remove('hidden');
        }

        function showRules() {
            document.getElementById('rulesModal').classList.remove('hidden');
        }

        function closeRules() {
            document.getElementById('rulesModal').classList.add('hidden');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>

    <!-- Rules Modal -->
    <div id="rulesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="max-w-4xl w-full max-h-[90vh] overflow-y-auto rounded-2xl shadow-2xl bg-white">
            <div class="sticky top-0 p-6 border-b bg-white border-gray-200">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold text-gray-800">ğŸ“– DetaylÄ± Americano KurallarÄ±</h2>
                    <button onclick="closeRules()" class="p-2 rounded-lg transition-all bg-gray-100 hover:bg-gray-200 text-gray-700">
                        âœ•
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <div class="space-y-6 text-gray-700">
                    <div>
                        <h5 class="font-semibold text-lg mb-3 text-blue-700">ğŸ¯ Oyun Malzemeleri:</h5>
                        <ul class="space-y-1 ml-4">
                            <li>â€¢ <strong>52'lik deste + 4 Joker</strong> ile oynanan kaÄŸÄ±t oyunudur</li>
                            <li>â€¢ <strong>Min 3, Max 5 kiÅŸi</strong> ile oynanÄ±r</li>
                            <li>â€¢ <strong>Her oyuncuya 13 kaÄŸÄ±t</strong> daÄŸÄ±tÄ±lÄ±r</li>
                        </ul>
                    </div>

                    <div>
                        <h5 class="font-semibold text-lg mb-3 text-blue-700">ğŸ“š Terimler SÃ¶zlÃ¼ÄŸÃ¼:</h5>
                        <ul class="space-y-1 ml-4">
                            <li>â€¢ <strong>KÃ¼t:</strong> AynÄ± rakamÄ±n farklÄ± kart Ã§eÅŸitleri (Ã¶rnek: 3â™ , 3â™¥, 3â™¦)</li>
                            <li>â€¢ <strong>Seri:</strong> Bir kart Ã§eÅŸidinin sÄ±ralÄ± ÅŸekilde bulunmasÄ± (Ã¶rnek: 2â™ , 3â™ , 4â™ )</li>
                            <li>â€¢ <strong>Joker:</strong> Ä°stenilen kart yerine geÃ§er</li>
                            <li>â€¢ <strong>Ä°ÅŸler KaÄŸÄ±t:</strong> Yere atÄ±lan ve baÅŸka oyuncuya yaramayan kart (-50 puan)</li>
                            <li>â€¢ <strong>Ceza KartÄ±:</strong> SÄ±rasÄ± olmayan oyuncunun Ã§ektiÄŸi ekstra kart</li>
                        </ul>
                    </div>

                    <div>
                        <h5 class="font-semibold text-lg mb-3 text-blue-700">ğŸ† Puan Sistemi:</h5>
                        <ul class="space-y-1 ml-4">
                            <li>â€¢ <strong>CezayÄ± sÃ¶yleyen + bitiren:</strong> +50 bonus puan</li>
                            <li>â€¢ <strong>CezayÄ± sÃ¶yleyen baÅŸarÄ±sÄ±z:</strong> GÃ¶revini yapamadan (aÃ§amadan) baÅŸkasÄ± bitirirse x2 ceza puanÄ± alÄ±r</li>
                            <li>â€¢ <strong>Ä°ÅŸler kaÄŸÄ±t atan:</strong> -50 ceza puanÄ±</li>
                            <li>â€¢ <strong>Joker ile bitiren:</strong> Herkese x2 ceza puanÄ±</li>
                            <li>â€¢ <strong>Son elde bonus yok:</strong> Elden cezasÄ±nda +50 bonus alÄ±namaz</li>
                        </ul>
                    </div>

                    <div>
                        <h5 class="font-semibold text-lg mb-3 text-purple-700">âš¡ Yeni Ã–zellikler:</h5>
                        <ul class="space-y-1 ml-4">
                            <li>â€¢ <strong>Ã–zel Cezalar:</strong> Kendi ceza tÃ¼rlerinizi oluÅŸturabilirsiniz</li>
                            <li>â€¢ <strong>Oyun GeÃ§miÅŸi:</strong> TÃ¼m oyunlarÄ±nÄ±z kaydedilir ve detaylarÄ±yla gÃ¶rÃ¼ntÃ¼leyebilirsiniz</li>
                            <li>â€¢ <strong>Mobil Uyumlu:</strong> Telefonda rahatÃ§a kullanabilirsiniz</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
